<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<sect1 xmlns="http://docbook.org/ns/docbook" 
  xmlns:xi="http://www.w3.org/2001/XInclude" 
  xmlns:xlink="http://www.w3.org/1999/xlink" 
  version="5.0" 
  xml:id="sec-security-ldap-backup">
 <title>Backing up and restoring LDAP servers</title>

 <para>
  &ds389; supports making offline and online backups. The
  <command>dsctl</command> command makes offline database backups, and the
  <command>dsconf</command> command makes online database backups. Back up the
  LDAP server configuration directory, to enable complete restoration in case
  of a major failure.
 </para>

 <sect2 xml:id="sec-security-ldap-backup-config">
  <title>Backing up the LDAP server configuration</title>
  <para>
   Your LDAP server configuration is in the directory
   <filename>/etc/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable></filename>.
   This directory contains certificates, keys, and the <filename>dse.ldif</filename>
   file. Make a compressed backup of this directory with the
   <command>tar</command> command:
  </para>
<screen>&prompt.sudo;<command>tar caf config_slapd-<replaceable>INSTANCE_NAME</replaceable>_$(date +%Y-%m-%d_%H-%M-%S).tar.gz /etc/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable>/</command></screen>
  <note role="compact">
   <para>
    When running <command>tar</command>, you may see the harmless informational
    message <literal>tar: Removing leading `/' from member names</literal>.
   </para>
  </note>
  <para>
   To restore a previous configuration, unpack it to the same directory:
  </para>
  <procedure>
   <step performance="optional">
    <para>
     To avoid overwriting it, move any existing configuration:
    </para>
<screen>&prompt.sudo;<command>old /etc/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable>/</command></screen>
   </step>
   <step>
    <para>
     Unpack the backup archive:
    </para>
<screen>&prompt.sudo;<command>tar -xvzf config_slapd-<replaceable>INSTANCE_NAME</replaceable>_<replaceable>DATE</replaceable>.tar.gz</command></screen>
   </step>
   <step>
    <para>
     Copy it to
     <filename>/etc/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable></filename>:
    </para>
<screen>&prompt.sudo;<command>cp -r <replaceable>etc/dirsrv/slapd-INSTANCE_NAME</replaceable> /etc/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable></command></screen>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec-security-ldap-offline-backup">
  <title>Creating an offline backup of the LDAP database and restoring from it</title>
  <para>
   The <command>dsctl</command> command makes offline backups. Stop the server:
  </para>
<screen>&prompt.sudo;<command>dsctl <replaceable>INSTANCE_NAME</replaceable> stop</command>
Instance "<replaceable>INSTANCE_NAME</replaceable>" has been stopped</screen>
  <para>
   Then make the backup using your instance name:
  </para>
<screen>&prompt.sudo;<command>dsctl <replaceable>INSTANCE_NAME</replaceable> db2bak</command>
db2bak successful</screen>
  <para>
   This example creates a backup archive at
   <filename>/var/lib/dirsrv/slapd-INSTANCE_NAME/bak/INSTANCE_NAME-2021_07_26_13_03_17</filename>.
  </para>
  <para>
   Restore from this backup, naming the directory containing the backup
   archive:
  </para>
<screen>&prompt.sudo;<command>dsctl <replaceable>INSTANCE_NAME</replaceable> bak2db <replaceable>/var/lib/dirsrv/slapd-INSTANCE_NAME/bak/INSTANCE_NAME-2021_07_26_13_03_17/</replaceable></command>
bak2db successful</screen>
  <para>
   Then start the server:
  </para>
<screen>&prompt.sudo;<command>dsctl <replaceable>INSTANCE_NAME</replaceable> start</command>
Instance "<replaceable>INSTANCE_NAME</replaceable>" has been started</screen>
  <para>
   You can also create LDIF backups:
  </para>
<screen>&prompt.sudo;<command>dsctl <replaceable>INSTANCE_NAME</replaceable> db2ldif --replication userRoot</command>
ldiffile: <replaceable>/var/lib/dirsrv/slapd-INSTANCE_NAME/ldif/INSTANCE_NAME-userRoot-2021_07_28_08_47_30.ldif</replaceable>
db2ldif successful</screen>
  <para>
   To restore an LDIF backup with the name of the archive, then start the server:
  </para>
<screen>&prompt.sudo;<command>dsctl ldif2db userRoot <replaceable>/var/lib/dirsrv/slapd-INSTANCE_NAME/ldif/INSTANCE_NAME-userRoot-2021_07_28_08_47_30.ldif</replaceable></command>
&prompt.sudo;<command>dsctl INSTANCE_NAME start</command></screen>
 </sect2>

 <sect2 xml:id="sec-security-ldap-online-backup">
  <title>Creating an online backup of the LDAP database and restoring from it</title>
  <para>
   Use the <command>dsconf</command> to make an online backup of your LDAP
   database:
  </para>
<screen>&prompt.sudo;<command>dsconf <replaceable>INSTANCE_NAME</replaceable> backup create</command>
The backup create task has finished successfully</screen>
  <para>
   This creates
   <replaceable>/var/lib/dirsrv/slapd-INSTANCE_NAME/bak/INSTANCE_NAME-2021_07_28_09_46_08</replaceable>.
  </para>
  <para>
   Restore it:
  </para>
<screen>&prompt.sudo;<command>dsconf <replaceable>INSTANCE_NAME</replaceable> backup restore <replaceable>/var/lib/dirsrv/slapd-INSTANCE_NAME/bak/INSTANCE_NAME-2021_07_28_09_46_08</replaceable></command></screen>
 </sect2>
</sect1>
