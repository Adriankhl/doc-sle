<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
  <!ENTITY % entities SYSTEM "generic-entities.ent">
    %entities;
]>

<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="sec-pam-login">
  <title>Configuring U2F on local login</title>
  <para>
    To provide more security during the local login to &slema;, you can configure two-factor authentication using the <literal>pam-u2f</literal> framework and the U2F feature on Yubikeys and Security Keys. The <literal>pam-u2f</literal> is installed in &slema; by default.
  </para>
  
  <para>
    To set up U2F on your &slema; system, you need to first register your YubiKey or Security Key. After the registeration, you need to associate your key to your account on &slema;. The last step of the process is to configure your system to use the key.
  </para>

  
  <sect2 xml:id="sec-attach-account">
    <title>Associating the U2f key with your account</title>
    <para>
      To associate your U2F key with yor account proceed as follows:
    </para>
    <procedure>
      <step>
        <para>
          Log in to your machine.
        </para>
      </step>
      <step>
        <para>
          Insert your U2F key.
        </para>
      </step>
      <step>
        <para>
          Create a directory for the U2F key configuration:
        </para>
        <screen>&prompt.sudo;mkdir -p ~/.config/Yubico</screen>
      </step>
      <step>
        <para>
          Run the <command>pamu2fcfg</command> that outputs configuration lines:
        </para>
        <screen>&prompt.sudo;pamu2fcfg > ~/.config/Yubico/u2f_keys</screen>
      </step>
      <step>
        <para>
          When your device begins flashing, touch the metal contact to confirm the association.
        </para>
      </step>
      </procedure>
      <para>
        We recommend using a backup U2F device, which you can set up by running the following commands:
      </para>
      <procedure>
        <step>
          <para>
            Run:
          </para>
          <screen>&prompt.sudo;pamu2fcfg -n >> ~/.config/Yubico/u2f_keys</screen>
        </step>
        <step>
          <para>
            When your device begins flashing, touch the metal contact to confirm the association.
          </para>
        </step>
      </procedure>
      <para>
        You can move the output file to a directory that requires the <literal>sudo</literal> permission to modify the file, for example, <filename>/etc</filename>. To do so, follow the steps:
      </para>
      <procedure>
        <step>
          <para>
            Create a directory in <filename>/etc</filename>:
          </para>
          <screen>&prompt.sudo;mkdir /etc/Yubico</screen>
        </step>
        <step>
          <para>
            Move the created file:
          </para>
          <screen>&prompt.sudo;mv ~/.config/Yubico/u2f_keys /etc/Yubico/u2f_keys</screen>
        </step>
      </procedure>

  </sect2>

  <sect2 xml:id="sec-reconfiguring-pam">
    <title>Updating the PAM configuration</title>
    <para>
      After you have created the U2F keys configuration, you need to adjust the PAM configuration on your system.
    </para>
    <procedure>
      <step>
        <para>
          Open the file <filename>/etc/pam.d/login</filename>.
        </para>
        <screen>
#%PAM-1.0
auth      include    common-auth
account   include    common-account
password  include    common-password
session   optional   pam_keyinit.so revoke
session   include    common-session
#session  optional   pam_xauth.so
        </screen>
      </step>
      <step>
        <para>
          Add the line <literal>auth       required   pam_u2f.so</literal> to the file as follows:
        </para>
        <screen>
#%PAM-1.0
auth      include    common-auth
auth      required   pam_u2f.so
account   include    common-account
password  include    common-password
session   optional   pam_keyinit.so revoke
session   include    common-session
#session  optional   pam_xauth.so
        </screen>
      </step>
    </procedure>
  </sect2>

  </sect1>