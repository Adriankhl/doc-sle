<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="security_ldap.xml" version="5.0" xml:id="cha-security-ldap">
 <title>LDAP － 目录服务</title>
 <info>
      <abstract>
        <para>
    轻量级目录访问协议 (LDAP) 是设计用来访问和维护信息目录的协议。LDAP 可用于用户和组管理、系统配置管理、地址管理等。本章提供 LDAP 工作原理的基本知识。
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker>
          </dm:bugtracker>
        <dm:translation>是</dm:translation>
      </dm:docmanager>
    </info>
    <para>
   理想情况下，中心服务器会将数据储存在一个目录中，并使用明确定义的协议将其分发到所有客户端。结构化数据使各种应用程序都能对其进行访问。中心储存库减少了必要的管理工作。利用 LDAP 这样的标准化开放协议可以确保尽可能多的客户端应用程序都能访问这些信息。
  </para>
  <para>
   这里所说的目录实际上是指一种经过优化能够快速有效地读取和搜索的数据库。储存在此目录中的数据类型往往会长期保留，且不会经常更改。这样，便可以针对高性能的并发读取优化 LDAP 服务，而传统数据库的优化目的是在短时间内接受大量的数据写入。
  </para>

 <sect1 xml:id="sec-security-ldap-tree">
  <title>LDAP 目录树的结构</title>

   <para>
   本节介绍 LDAP 目录树的布局，并提供 LDAP 相关的基本术语。<phrase os="sles;osuse">如果您熟悉 LDAP，请继续阅读<xref linkend="sec-security-ldap-server"/>。</phrase>
  </para>

  <para>
   LDAP 目录具有树形结构。目录中的所有项（称为对象）在此层次结构中都有确定的位置。此层次结构称为<emphasis>目录信息树</emphasis> (DIT)。所需项的完整路径（可以明确标识该项）称为<emphasis>判别名</emphasis> (DN)。树中的对象由其<emphasis>相对判别名</emphasis> (RDN) 标识。判别名是基于项路径中的所有项的 RDN 构建的。
  </para>

  <para>
   LDAP 目录树中的关系在下例中尤为明显，如<xref linkend="fig-ldap-tree"/>所示。
  </para>

  <figure xml:id="fig-ldap-tree">
   <title>LDAP 目录的结构</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="ldap_tree.svg" width="85%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="ldap_tree.png" width="85%" format="PNG"/>
    </imageobject>
   </mediaobject>
  </figure>

  <para>
   完整的图是一个虚构的目录信息树。其中描述了三个层次上的项。每个项对应于图中的一个框。在本例中，虚构的雇员 <emphasis>Geeko Linux</emphasis> 的完整有效<systemitem class="username">判别名</systemitem>为 <literal>cn=Geeko Linux,ou=doc,dc=example,dc=com</literal>。该名称是通过将 RDN <literal>cn=Geeko linux</literal> 添加到前一项的 DN <literal>ou=doc,dc=example,dc=com</literal> 而构成的。
  </para>



  <para>
   可储存在 DIT 中的对象类型是按照<emphasis>纲要</emphasis>全局确定的。对象类型由<emphasis>对象类</emphasis>决定。对象类确定必须或可以指派给相关对象的属性。纲要包含 LDAP 服务器可以使用的所有对象类和属性。属性是结构化数据类型。其语法、顺序和其他行为由纲要定义。LDAP 服务器会提供一组可在各种环境中工作的核心纲要。如果您需要使用自定义纲要，可以将其上载到 LDAP 服务器。
  </para>

  <para>
   <xref linkend="tab-ldap-schema"/>提供了示例中所用 <filename>00core.ldif</filename> 和 <filename>06inetorgperson.ldif</filename> 中的对象类的简单概述，包括必需的属性（必需属性）和有效的属性值。安装 <systemitem>389-ds</systemitem> 后，可在 <filename>usr/share/dirsrv/schema</filename> 中找到这些信息。

  </para>

  <table xml:id="tab-ldap-schema">
   <title>常用对象类和特性</title>
   <tgroup cols="4">
    <colspec colname="c1" colwidth="30*"/>
    <colspec colname="c2" colwidth="32*"/>
    <colspec colname="c3" colwidth="16*"/>
    <colspec colname="c4" colwidth="22*"/>
    <thead>
     <row>
      <entry>
       <para>
        对象类
       </para>
      </entry>
      <entry>
       <para>
        含义
       </para>
      </entry>
      <entry>
       <para>
        示例项
       </para>
      </entry>
      <entry>
       <para>
        必需属性
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        <literal>域</literal>
       </para>
      </entry>
      <entry>
       <para>
        域的名称组成部分
       </para>
      </entry>
      <entry>
       <para>
        示例
       </para>
      </entry>
      <entry>
       <para>
        displayName
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <literal>organizationalUnit</literal>
       </para>
      </entry>
      <entry>
       <para>
        组织单元
       </para>
      </entry>
      <entry>
       <para>
        doc
       </para>
      </entry>
      <entry>
       <para>
        ou
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <literal>nsPerson</literal>
       </para>
      </entry>
      <entry>
       <para>
        内部网或因特网中与个人相关的数据
       </para>
      </entry>
      <entry>
       <para>
        Geeko Linux
       </para>
      </entry>
      <entry>
       <para>
        cn
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>

  <para>
   <xref linkend="aus-ldap-schema-help"/>显示了某个纲要指令的摘录及其解释。
  </para>

  <example xml:id="aus-ldap-schema-help">
   <title>CN=schema 的摘录</title>
<screen>attributetype (1.2.840.113556.1.2.102 NAME 'memberOf' <co xml:id="co-ldap-schema-core-att-type"/>
       DESC 'Group that the entry belongs to' <co xml:id="co-ldap-schema-core-desc"/>
       SYNTAX 1.3.6.1.4.1.1466.115.121.1.12 <co xml:id="co-ldap-schema-core-syntax"/>
       X-ORIGIN 'Netscape Delegated Administrator') <co xml:id="co-ldap-schema-core-xorigin"/>

objectclass (2.16.840.1.113730.3.2.333 NAME 'nsPerson' <co xml:id="co-ldap-schema-core-oc"/>
       DESC 'A representation of a person in a directory server' <co xml:id="co-ldap-schema-core-desc-oc"/>
       SUP top STRUCTURAL <co xml:id="co-ldap-schema-core-sup-oc"/>
       MUST ( displayName $ cn ) <co xml:id="co-ldap-schema-core-must-oc"/>
       MAY ( userPassword $ seeAlso $ description $ legalName $ mail \
             $ preferredLanguage ) <co xml:id="co-ldap-schema-core-may-oc"/>
       X-ORIGIN '389 Directory Server Project’
  ...</screen>
  </example>
  <calloutlist>
   <callout arearefs="co-ldap-schema-core-att-type">
    <para>
     属性的名称、其唯一<emphasis>对象标识符</emphasis>（OID，数字格式）和属性的缩写。
    </para>
   </callout>
   <callout arearefs="co-ldap-schema-core-desc">
    <para>
     通过 <literal>DESC</literal> 对该属性提供的简要说明。在此还可以指出定义所基于的相应 RFC。
    </para>
   </callout>
   <callout arearefs="co-ldap-schema-core-syntax">
    <para>
      可保存在该属性中的数据类型。在本例中，它是一个不区分大小写的目录字符串。
    </para>
   </callout>
   <callout arearefs="co-ldap-schema-core-xorigin">
    <para>
     纲要元素（例如项目的名称）的来源。
    </para>
   </callout>
   <callout arearefs="co-ldap-schema-core-oc">
    <para>
     对象类 <literal>nsPerson</literal> 的定义以 OID 以及该对象类的名称开头（与属性的定义类似）。
    </para>
   </callout>
   <callout arearefs="co-ldap-schema-core-desc-oc">
    <para>
     对象类的简要说明。
    </para>
   </callout>
   <callout arearefs="co-ldap-schema-core-sup-oc">
    <para>
     <literal>SUP top</literal> 项指示此对象类不从属于另一个对象类。
    </para>
   </callout>
   <callout arearefs="co-ldap-schema-core-must-oc">
    <para>
     <literal>MUST</literal> 列出必须对 <literal>nsPerson</literal> 类型的对象使用的所有属性类型。
    </para>
   </callout>
   <callout arearefs="co-ldap-schema-core-may-oc">
    <para>
     <literal>MAY</literal> 列出可选择对此对象类使用的所有属性类型。
    </para>
   </callout>
  </calloutlist>
 </sect1>

 <sect1 xml:id="sec-security-ldap-server-install">
  <title>安装 389 目录服务器的软件</title>
   <para>
    <systemitem>389-ds</systemitem> 软件包中包含 389 目录服务器和管理工具。如果尚未安装该软件包，请使用以下命令安装：</para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> zypper install 389-ds</screen>
    <para>
     安装后，可以手动设置服务器<phrase os="sles;osuse">（如<xref linkend="sec-security-ldap-server" xrefstyle="select:label"/>中所述）</phrase>，或使用 YaST 创建一个非常基本的设置<phrase os="sles;osuse">（如<xref linkend="sec-security-ldap-server-yast" xrefstyle="select:label"/>中所述）</phrase>。
    </para>
 </sect1>

 <sect1 xml:id="sec-security-ldap-server" os="sles;osuse">
  <title>手动配置 389 目录服务器</title>
  <para>
   设置 389 目录服务器需要执行以下基本步骤：
  </para>
  <procedure>
   <step>
    <para>
     
     <xref linkend="sec-security-ldap-server-instance" xrefstyle="select:title"/>
    </para>
   </step>
   <step>
    <para>
     
      <xref linkend="sec-security-ldap-server-ca" xrefstyle="select:title"/>
    </para>
   </step>
   <step>
    <para>
     
      <xref linkend="sec-security-ldap-server-credentials" xrefstyle="select:title"/>
    </para>
   </step>
   <step>
    <para>
    
     <xref linkend="sec-security-ldap-server-users" xrefstyle="select:title"/>
    </para>
   </step>
   <step>
    <para>
    
     <xref linkend="sec-security-ldap-server-sssd" xrefstyle="select:title"/>
    </para>
   </step>
  </procedure>
  <para>
   <remark>taroth 2019-06-19: some topics like 'configuring other applications'
    and 'backup and restore' to be added later on</remark>
  </para>
   
   <para>
   389 目录服务器由三个主要命令控制：
  </para>
  <variablelist>
   <varlistentry>
    <term><command>dsctl</command></term>
    <listitem>
     <para>
      管理本地实例，需要 <systemitem class="username">root</systemitem> 权限。要求您连接到运行目录服务器实例的终端。用于启动、停止和备份数据库以及进行其他操作。
     </para>
    </listitem>
   </varlistentry>
    <varlistentry>
     <term><command>dsconf</command></term>
     <listitem>
      <para>
       用于管理和配置服务器的主要工具。可通过实例的外部接口管理其配置。这样，您便可以在该实例上远程更改配置。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><command>dsidm</command></term>
     <listitem>
      <para>
       用于身份管理（管理用户、组、口令等）。权限由访问控制授予，因此，举例而言，用户可以重设置自己的口令或更改自己帐户的细节。
      </para>
     </listitem>
    </varlistentry>
  </variablelist>

  <sect2 xml:id="sec-security-ldap-server-instance">
  <title>创建 389 目录服务器实例</title>
    <para>
     您可使用 <command>dscreate</command> 命令创建实例。此命令可以接受一个用于定义实例配置设置的配置文件 (<filename>*.inf</filename>)。或者，可采取交互方式运行该命令。
    </para>
    <note>
     <title>实例名称</title>
      <para>
       如果未指定为其他值，默认实例名称为 <literal>localhost</literal>。创建实例后即无法更改实例名称。</para>
    </note>
    <para>
     <xref linkend="ex-ldap-389-ds-inf" xrefstyle="select:label"/> 显示了可让您作为着手点的示例配置文件。或者，您可以使用 <command>dscreate create-template</command> 创建一个 <filename>*.inf</filename> 模板文件。该模板带有注释并已预先填充内容，因此您可以根据需要调整其变量。有关更多细节，请参见 <command>dscreate</command> 的手册页。
    </para>
   <procedure>
    <step>
     <para>
      如果您要设置一个试用实例，请启动编辑器并将以下内容保存为 <filename>/tmp/instance.inf</filename>：
     </para>
     <example xml:id="ex-ldap-389-ds-inf">
      <title>基本实例配置文件</title>
      <screen># /tmp/instance.inf
[general]
config_version = 2

[slapd]
root_password = <replaceable>YOUR_PASSWORD_FOR_CN=DIRECTORY_MANAGER</replaceable><co xml:id="co-ldap-389-ds-rootpasswd"/>

[backend-userroot]
sample_entries = yes
suffix = dc=example,dc=com</screen>
      <calloutlist>
       <callout arearefs="co-ldap-389-ds-rootpasswd">
        <para>
         将 <varname>root_password</varname> 设置为目录服务器 <systemitem class="username">root</systemitem> 用户的口令。该口令仅用于 LDAP 服务器管理。
        </para>
       </callout>
      </calloutlist>
     </example>
   </step>
   <step>
    <para>
     要基于<xref linkend="ex-ldap-389-ds-inf" xrefstyle="select:label"/> 创建 389 目录服务器实例，请运行：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> dscreate from-file /tmp/instance.inf</screen>
    <para>
     这会创建一个可运行的 LDAP 服务器。
    </para>
   </step>
   <step>
    <para>
     如果 <command>dscreate</command> 失败，会显示消息告诉您原因。如需更多细节，请使用 <option>-v</option> 选项重复该命令：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> dscreate -v from-file /tmp/instance.inf</screen>
   </step>
   <step>
    <para>
     使用以下命令检查服务器的状态：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> dsctl localhost status
instance 'Localhost' is running</screen>
   </step>
   <step>
    <para>
     如果您以后想要删除实例，请运行以下命令：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> dsctl localhost remove --do-it</screen>
    <para>
     使用此命令还可以去除部分安装的实例或已损坏的实例。
    </para>
   </step>
  </procedure>
 </sect2>

<sect2 xml:id="sec-security-ldap-server-ca">
 <title>使用 TSL 的 CA 证书</title>
 <para>
  您可以使用以下命令行工具管理 389 目录服务器的 CA 证书：<command>certutil</command>、<command>openssl</command> 和 <command>pk12util</command>。
 </para>
 <para>
  如要进行测试，您可以使用 <command>dscreate</command> 创建一个自我签名证书。该证书储存在 <filename>/etc/dirsrv/slapd-localhost/ca.crt</filename> 中。如要进行远程管理，需将该证书复制到某个可读取的位置。对于生产环境，请联系您的组织所选的 CA 机构，并请求服务器证书、客户端证书和根证书。
 </para>
 <para>
 在执行以下过程之前，请确保符合下述要求：
 </para>
 <itemizedlist>
  <listitem>
   <para>
    您拥有可用于建立 TSL 连接的服务器证书和私用密钥。
   </para>
  </listitem>
  <listitem>
   <para>
    已设置 NSS（网络安全服务）数据库（例如，使用 <command>certutil</command> 命令设置）。
   </para>
  </listitem>
 </itemizedlist>

 <procedure>
  <para>
  在可将现有私用密钥和证书导入 NSS（网络安全服务）数据库之前，需要创建私用密钥和服务器证书的捆绑包。这会生成一个 <filename>*.p12</filename> 文件。
  </para>
  <important>
  <title><filename>*.p12</filename> 文件和友好名称</title>
  <para>
   在创建 PKCS12 捆绑包时，必须将 <filename>*.p12</filename> 文件中的友好名称进行编码。
  </para>
  <para>
   请务必使用 <literal>Server-Cert</literal> 作为友好名称，否则 TLS 连接将会失败，因为 389 目录服务器只会搜索此字符串。
  </para>
  <para>
    请注意，将 <filename>*.p12</filename> 文件导入 NSS 数据库后，就无法更改该友好名称。
  </para>
 </important>
 <step>
  <para>
   使用下面的命令可创建包含所需友好名称的 PKCS12 捆绑包：
  </para>
 <screen><prompt role="root">root # </prompt>openssl pkcs12 -export -in <replaceable>SERVER.crt</replaceable> \
  -inkey <replaceable>SERVER.key</replaceable> -out <replaceable>SERVER.p12</replaceable> \
  -name Server-Cert</screen>
  <para>
   请将 <replaceable>SERVER.crt</replaceable> 替换为服务器证书，将 <replaceable>SERVER.key</replaceable> 替换为要捆绑的私用密钥。使用 <option>-out</option> 指定 <filename>*.p12</filename> 文件的名称。使用 <option>-name</option> 设置要使用的友好名称：<literal>Server-Cert</literal>。
  </para>
 </step>
 <step>
   <para>
     在可将该文件导入 NSS 数据库之前，需获取该文件的口令。为此，请使用下面的命令：
   </para>
<screen>pk12util -i <replaceable>PATH_TO_SERVER.p12</replaceable> -d sql:PATH_TO_NSS_DB -n Server-cert -W <replaceable>SERVER.p12_PASSWORD</replaceable></screen>
   <para>
     然后，您便可在 <replaceable>PATH_TO_NSS_DB</replaceable> 目录下的 <filename>pwdfile.txt</filename> 文件中找到该口令。
   </para>
 </step>
 <step>
  <para>
   现在，将 <replaceable>SERVER.p12</replaceable> 文件导入 NSS 数据库：
  </para>
  <screen>pk12util -i <replaceable>SERVER.p12</replaceable> -d <replaceable>PATH_TO_NSS_DB</replaceable></screen>
 </step>
 </procedure>
</sect2>

 <sect2 xml:id="sec-security-ldap-server-credentials">
  <title>配置用于进行远程/本地访问的管理身份凭证</title>
   <para>
    要对 389 目录服务器进行远程或本地管理，可以在主目录中创建一个 <filename>.dsrc</filename> 配置文件。这可以避免每运行一个命令都要键入您的用户名和连接细节。<xref linkend="ex-security-ldap-server-credentials-remote" xrefstyle="select:label"/> 显示的是用于远程管理的示例配置文件，而<xref linkend="ex-security-ldap-server-credentials-local" xrefstyle="select:label"/> 显示的是用于本地管理的示例配置文件。
   </para>
  <example xml:id="ex-security-ldap-server-credentials-remote">
   <title>用于远程管理的 <filename>.dsrc</filename> 文件</title>
   <screen># cat ~/.dsrc
[localhost]
uri = ldaps://<replaceable>REMOTE_URI</replaceable> <co xml:id="co-ldap-server-dsrc-remote-localhost"/>
basedn = dc=example,dc=com
binddn = cn=Directory Manager
tls_cacertdir = PATH_TO_CERTDIR <co xml:id="co-ldap-server-dsrc-remote-cert"/></screen>
   <calloutlist>
    <callout arearefs="co-ldap-server-dsrc-remote-localhost">
     <para>
      需要指向 LDAP 服务器实例。如果未指定为其他值，默认实例名称为 <literal>localhost</literal>。
     </para>
    </callout>
    <callout arearefs="co-ldap-server-dsrc-remote-cert">
     <para>
      证书的路径，位于您要从中使用 <command>ds*</command> 命令的可读取位置或客户端计算机上。
     </para>
    </callout>
   </calloutlist>
  </example>
  <para>
   如果您要在运行 389 目录服务器的同一台主机上管理实例，请使用<xref linkend="ex-security-ldap-server-credentials-local" xrefstyle="select:label"/> 中的配置文件。
  </para>
  <example xml:id="ex-security-ldap-server-credentials-local">
   <title>用于本地管理的 <filename>.dsrc</filename> 文件</title>
   <screen># cat ~/.dsrc
[localhost]
# Note that '/' is replaced with '%%2f'.
uri = ldapi://%%2fvar%%2frun%%2fslapd-localhost.socket <co xml:id="co-ldap-server-dsrc-remote-ldapi"/>
basedn = dc=example,dc=com
binddn = cn=Directory Manager
</screen>
   <calloutlist>
    <callout arearefs="co-ldap-server-dsrc-remote-ldapi">
      <para>
        在运行 389 目录服务器实例的服务器上使用 <literal>ldapi</literal> 时，系统将会检测您的 UID/GID。如果该 UID/GID 是 <literal>0/0</literal>（表示您是以 <systemitem class="username">root</systemitem> 用户身份登录的），<literal>ldapi</literal> 会绑定本地 <systemitem class="username">root</systemitem> 作为实例的目录服务器 root dn (<literal>cn=Directory Manager</literal>)。这可以实现服务器的本地管理，同时还可让您为 <literal>cn=Directory Manager</literal> 设置一个机器生成且无人知道的口令。对托管 389 目录服务器实例的服务器拥有管理员权限的任何人都能以 <literal>cn=Directory Manager</literal> 的身份访问该实例。
      </para>
    </callout>
   </calloutlist>
  </example>
 </sect2>

 <sect2 xml:id="sec-security-ldap-server-users">
  <title>配置 LDAP 用户和组</title>
   <para>
    可以使用 <command>dsidm</command> 命令创建与管理用户和组。此命令以交互方式运行，或者您可以在命令行中结合参数使用该命令。
   </para>
  <para>
   在下面的示例中，我们通过命令行参数指定相应数据来添加两个用户：<systemitem class="username">wilber</systemitem> 和 <systemitem class="username">geeko</systemitem>。
  </para>
  <procedure xml:id="pro-security-ldap-server-users">
   <title>创建 LDAP 用户</title>
   <step>
    <para>
    创建用户 <systemitem class="username">wilber</systemitem>：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>dsidm</command> localhost user create --uid <systemitem class="username">wilber</systemitem> \
  --cn <systemitem class="username">wilber</systemitem> --displayName 'Wilber Fox' --uidNumber 1000 --gidNumber 1000 \
  --homeDirectory /home/<systemitem class="username">wilber</systemitem></screen>
   </step>
   <step>
    <para>
     要查找用户的<literal>判别名</literal>（目录对象的完全限定名称，能够确保唯一）：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> dsidm localhost user get <systemitem class="username">wilber</systemitem>
dn: uid=<systemitem class="username">wilber</systemitem>,ou=people,dc=example,dc=com
[...]</screen>
    <para>
     系统会提示您输入目录服务器的 <systemitem class="username">root</systemitem> 用户口令（除非您按<xref linkend="sec-security-ldap-server-credentials"/>中所述配置了远程或本地访问）。
    </para>
    <para>
     执行更改用户口令等操作时需要用到判别名。
    </para>
   </step>
   <step>
    <para>
     要设置或更改 <systemitem class="username">wilber</systemitem> 的口令，请执行以下操作：
    </para>
    <substeps>
      <step>
       <screen><prompt>tux &gt; </prompt><command>sudo</command> dsidm localhost account reset_password \
  uid=<systemitem class="username">wilber</systemitem>,ou=people,dc=example,dc=com</screen>
       <para>
        系统会提示您输入目录服务器的 <systemitem class="username">root</systemitem> 用户口令（除非您按<xref linkend="sec-security-ldap-server-credentials"/>中所述配置了远程或本地访问）。
       </para>
      </step>
      <step>
       <para>
        输入 <systemitem class="username">wilber</systemitem> 的新口令两次。
       </para>
       <para>
        如果操作成功，您将看到以下消息：
       </para>
       <screen>reset password for uid=<systemitem class="username">wilber</systemitem>,ou=people,dc=example,dc=com</screen>
      </step>
    </substeps>
   </step>
   <step>
    <para>创建用户 <systemitem class="username">geeko</systemitem>：</para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>dsidm</command> localhost user create --uid \
  --cn <systemitem class="username">geeko</systemitem> --displayName 'Suzanne Geeko' \
  --uidNumber 1001 --gidNumber 1001 --homeDirectory /home/<systemitem class="username">geeko</systemitem></screen>
   </step>
  </procedure>
  <procedure xml:id="pro-security-ldap-server-groups">
   <title>创建 LDAP 组并将用户指派到其中</title>
   <para>
    下面我们将创建 <systemitem class="groupname">server_admins</systemitem> 组，并将 <systemitem class="username">wilber</systemitem> 用户指派到此组。</para>
   <step>
    <para>
     创建组：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> dsidm localhost group create</screen>
    <para>
     系统会提示您输入组名：
    </para>
    <screen>Enter value for cn :</screen>
   </step>
   <step>
    <para>
     输入该组的名称，例如 <literal>server_admins</literal>。
    </para>
   </step>
   <step>
    <para>
     将用户 <systemitem class="username">wilber</systemitem> 添加到该组：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> dsidm localhost group add_member server_admins uid=<systemitem class="username">wilber</systemitem>,ou=people,dc=example,dc=com
added member: uid=<systemitem class="username">wilber</systemitem>,ou=people,dc=example,dc=com</screen>
   </step>
   <step>
    <para>
     校验身份验证是否正常工作：
    </para>
   <screen><prompt>tux &gt; </prompt><command>sudo</command> ldapwhoami -H ldaps://localhost -D \
  uid=<systemitem class="username">wilber</systemitem>,ou=people,dc=example,dc=com -W -x</screen>
    <para>
     如果系统提示您输入 <systemitem class="username">wilber</systemitem> 的 LDAP 口令，则表示身份验证正常工作。
    </para>
    <para>
     如果命令失败并显示以下错误，表示您可能使用了自我签名证书：
    </para>
    <screen>ldap_sasl_bind(SIMPLE): Can't contact LDAP server (-1)</screen>
    <para>
     在这种情况下，请编辑 <filename>/etc/openldap/ldap.conf</filename> 并添加证书的路径：例如：
    </para>
    <screen>TLS_CACERT /etc/dirsrv/slapd-localhost/ca.crt</screen>
    <para>
     或者，在 <filename>whoami</filename> 命令中包含证书的路径：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> LDAPTLS_CACERT=/etc/dirsrv/slapd-localhost/ca.crt \
  ldapwhoami -H ldaps://localhost -D \
  uid=<systemitem class="username">wilber</systemitem>,ou=people,dc=example,dc=com -W -x</screen>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec-security-ldap-server-sssd">
  <title>设置 SSSD</title>
  <para>
   SSSD（系统安全服务守护程序）是一个与远程身份提供者通讯并允许 <literal>pam</literal> 和 <literal>nsswitch</literal> 使用该数据的守护程序。SSSD 可以有多个后端，可缓存用户和组并提供 SSH 密钥分发等功能。
  </para>
  <procedure>
   <step>
     <para>在单独的服务器上安装 <systemitem>sssd</systemitem> 软件包：
     </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> zypper in sssd</screen>
   </step>
   <step>
    <para>
     禁用并停止 <systemitem class="daemon">nscd</systemitem> 守护程序，因为它与 <systemitem class="daemon">sssd</systemitem> 相冲突：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> systemctl disable nscd &amp;&amp; systemctl stop nscd</screen>
   </step>
   <step>
    <para>
     创建 SSSD 配置，并仅允许我们在<xref linkend="pro-security-ldap-server-groups" xrefstyle="select:label"/> 中创建的 <systemitem class="groupname">server_admins</systemitem> 组的成员登录：
    </para>
    <tip>
     <para>
      需要启用 <literal>memberOf</literal> 插件，以使客户端能够登录和授权。
     </para>
    </tip>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> dsidm localhost client_config sssd.conf server_admins</screen>
   </step>
   <step>
    <para>
     查看输出并将其粘贴（或重定向）到 <filename>/etc/sssd/sssd.conf</filename>。必要时，请根据需要编辑配置文件。
    </para>
   </step>
   <step>
    <para>
     要在您的客户端上配置证书，请将 LDAP 服务器中的 <filename>ca.crt</filename> 复制到您的客户端：</para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> mkdir -p /etc/openldap/certs
cp [...]&gt;/ca.crt /etc/openldap/certs/
/usr/bin/c_rehash /etc/openldap/certs</screen>
   </step>
   <step>
    <para>
     启用并启动 SSSD：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> systemctl enable sssd
systemctl start sssd</screen>
   </step>
   <step>
    <para>
     为确保 SSSD 成为 PAM 和 NSS 的一部分，请遵照 <link xlink:href="http://www.port389.org/docs/389ds/howto/howto-sssd.html"/> 上“<citetitle>Configure PAM (SUSE)</citetitle>”（配置 PAM (SUSE)）和“<citetitle>Configure NSS (SUSE)</citetitle>”（配置 NSS (SUSE)）章节中的说明操作。
    </para>
   </step>
   <step>
    <para>
     校验客户端能否提供用户 <systemitem class="username">wilber</systemitem> 的细节：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> id <systemitem class="username">wilber</systemitem>
    uid=1000(<systemitem class="username">wilber</systemitem>) gid=100(users) groups=100(users)</screen>
    <para>
     如果所有设置均正确无误，<systemitem class="username">wilber</systemitem> 可以通过与安装并配置了 SSSD 的计算机所建立的 SSH 连接访问 389 目录服务器实例。但 <systemitem class="username">geeko</systemitem> 做不到这一点，因为 <systemitem class="username">geeko</systemitem> 不属于我们在<xref linkend="pro-security-ldap-server-groups" xrefstyle="select:label"/> 中配置的 <literal>server_admins</literal> 组。
    </para>
   </step>
  </procedure>
 </sect2>
</sect1>

<sect1 xml:id="sec-security-ldap-server-yast" os="sles;osuse">
 <title>使用 YaST 设置 389 目录服务器</title>
  <para>
   您可以使用 YaST 快速创建非常基本的 389 目录服务器设置。
  </para>
 <sect2 xml:id="sec-security-ldap-server-yast-create">
  <title>使用 YaST 创建 389 目录服务器实例</title>
  <procedure>
   <step>
   <para>
    在 YaST 中，单击<menuchoice>
    <guimenu>网络服务</guimenu>
    <guimenu>创建新目录服务器</guimenu>
   </menuchoice>。或者，在命令行中使用 <command>yast2 ldap-server</command> 启动该模块。
   </para>
   <para>
    在打开的窗口中，需要在所有必填的文本字段中填入数据。
   </para>
  </step>
  <step>
   <para>
    输入 389 目录服务器的<guimenu>完全限定的域名</guimenu>。必须输入可以从主机解析的域名。
   </para>
  </step>
  <step>
   <para>
    在<guimenu>目录服务器实例名称</guimenu>中，输入 LDAP 服务器实例的本地名称。</para>
   <note>
    <title>实例名称</title>
    <para>
     创建实例后即<emphasis>无法</emphasis>更改实例名称。如果您只打算创建一个 LDAP 服务器，请使用默认实例名称 <literal>localhost</literal>。但如果您打算托管多个 LDAP 服务器，请为各个实例使用有意义的名称。
    </para>
   </note>
  </step>
  <step>
   <para>
   在<guimenu>目录后缀</guimenu>中，输入 LDAP 树的基础域名。它是按组件分割的域名。例如，<literal>example.com</literal> 将变成 <literal>dc=example,dc=com</literal>。
   </para>
  </step>
  <step>
   <para>
    在必填的安全选项中，输入目录管理者（LDAP 的 root/管理员帐户）的口令，并在下一步中再次输入该口令。该口令必须至少包含 8 个字符。
   </para>
  </step>
    <step>
     <para>
      要使用 CA 证书运行 389 目录服务器，请指定以下两个选项：
     </para>
     <substeps>
      <step>
       <para>
        输入用于为服务器证书签名的<guimenu>服务器 TLS 证书颁发机构（PEM 格式）</guimenu>的路径。<remark>taroth 2020-01-22: string may be simplified in the future, see
         https://github.com/yast/yast-auth-server/issues/55</remark>
       </para>
      </step>
      <step>
       <para>
        输入<guimenu>友好名称为“Server-Cert”的 PKCS12 格式服务器 TLS 证书和密钥</guimenu>的路径。<filename>*.p12</filename> 文件包含服务器的私用密钥和证书。这些证书必须由您前面指定的 PEM 格式的 CA 签名。<guimenu>友好名称</guimenu>必须是 <literal>Server-Cert</literal>，有关细节，请参见<xref linkend="sec-security-ldap-server-ca"/>。<remark>taroth 2020-01-22: string may be  simplified in the future, see
        https://github.com/yast/yast-auth-server/issues/55</remark>
       </para>
       <para>
        如果您在此处未指定 CA 证书，系统会自动创建一个自我签名证书。创建实例后，可在 <filename>/etc/dirsrv/slapd-<replaceable>INSTANCENAME</replaceable></filename> 中找到相关文件。
       </para>
      </step>
     </substeps>
    </step>
   <step>
   <para>
    如果您已准备好创建实例，请单击<guimenu>确定</guimenu>。
   </para>
   <informalfigure>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="yast2-ldap-server.png" width="95%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="yast2-ldap-server.png" width="90%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </informalfigure>
   <para>YaST 会显示一条消息，指出创建是否成功，以及可在何处找到日志文件。
   </para>
  </step>
  </procedure>

 
 
 <para>
  使用 YaST 进行设置只能提供 389 目录服务器的非常基本的配置。要微调其他设置，请参见<xref linkend="sec-security-ldap-server"/>，或<xref linkend="sec-security-ldap-info"/>中提到的文档。
 </para>
</sect2>



<sect2 xml:id="sec-security-ldap-yast-client">
  <title>使用 YaST 配置 LDAP 客户端</title>
  <para>
   YaST 包含 <guimenu>LDAP 和 Kerberos 客户端</guimenu>模块，可帮助您定义涉及到 LDAP 或 Kerberos 的身份验证方案。
  </para>
  <para>
   此模块还可用于单独加入 Kerberos 和 LDAP。但是，在许多此类情况下，此模块可能并不是第一选择，例如，加入 Active Directory（使用 LDAP 和 Kerberos 的组合）时。有关更多信息，请参见<xref linkend="sec-security-auth-yast-client"/>。
  </para>
  <para>
   选择<menuchoice> <guimenu>网络服务</guimenu> <guimenu>LDAP 和 Kerberos 客户端</guimenu> </menuchoice>启动该模块。
  </para>
  <figure xml:id="fig-yast2-ldapkerberos-ldap">
   <title><guimenu>LDAP 和 Kerberos 客户端</guimenu>窗口</title>
   <mediaobject>
    <imageobject role="html">
     <imagedata fileref="yast2_auth_client_config.png" width="65%" format="PNG"/>
    </imageobject>
    <imageobject role="fo">
     <imagedata fileref="yast2_auth_client_config.png" width="65%" format="PNG"/>
    </imageobject>
   </mediaobject>
  </figure>

  <para>
   要配置 LDAP 客户端，请执行以下过程：
  </para>
  <procedure xml:id="pro-security-auth-ldap">
   <step>
    <para>
     在 <guimenu>LDAP 和 Kerberos 客户端</guimenu>窗口中，单击<guimenu>更改设置</guimenu>。
    </para>
    <para>
     确保已选择<guimenu>使用目录作为身份提供者 (LDAP)</guimenu> 选项卡。
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="html">
       <imagedata fileref="yast2_auth_client_ldap.png" width="65%" format="PNG"/>
      </imageobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_auth_client_ldap.png" width="65%" format="PNG"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
   </step>
   <step>
    <para>
     
     在<guimenu>输入 LDAP 服务器位置</guimenu>下指定一个或多个 LDAP 服务器 URL 或主机名。出于安全原因，我们建议仅使用 <literal>LDAPS://</literal> URL。指定多个地址时，请用空格进行分隔。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>搜索基本的 DN</guimenu> 下指定适当的 LDAP 判别名 (DN)。例如，<literal>dc=example,dc=com</literal> 就是有效的输入内容。
    </para>
   </step>
   <step>
    <para>
     如果您的 LDAP 服务器支持 TLS 加密，请在<guimenu>安全 LDAP 连接</guimenu>下选择适当的安全选项。
    </para>
    <para>
     要先询问服务器是否支持 TLS 加密，并希望能够在服务器不支持 TLS 加密的情况下降级到未加密连接，请使用<guimenu>通过 StartTLS 确保通讯安全</guimenu>。
    </para>
   </step>
   <step>
    <para>
     根据需要激活其他选项：
    </para>
    <itemizedlist>
     <listitem>
      <para>
       可以<guimenu>允许用户通过 LDAP 进行身份验证</guimenu>，并在本地计算机上为用户<guimenu>自动创建主目录</guimenu>。
      </para>
     </listitem>
     <listitem>
      <para>
       如果您要在本地缓存 LDAP 项，请使用<guimenu>缓存 LDAP 项以加快响应速度</guimenu>。
      </para>
      <warning>
       <title>使用缓存可能存在的安全风险</title>
       <para>
        根据所用的机制，使用缓存可能会带来安全风险。
       </para>
       <variablelist>
        <varlistentry>
         <term>nscd</term>
         <listitem>
          <para>
           如果您定义了一个授权规则（例如，<literal>admin</literal> 组的成员可以登录），然后您去除了该组中的某个用户，那么，只有在缓存失效或刷新之后，客户端缓存才会注意到这项更改。因此，帐户已被撤消的用户稍后仍可登录。
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>sssd</term>
         <listitem>
          <para>
           此缓存机制会持续检查组成员资格是否仍然有效。因此，仅当 <literal>sssd</literal> 守护程序出于某种原因与 LDAP 服务器断开连接时，才存在这样的缓存风险。
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
      </warning>
     </listitem>
     <listitem>
      <para>
       指定应该从 LDAP 源（例如<guimenu>用户</guimenu>和<guimenu>组</guimenu>、<guimenu>超级用户命令</guimenu>及<guimenu>网络磁盘位置</guimenu>（可按请求自动装入的网络共享驱动器））使用的数据类型。
      </para>
     </listitem>
     <listitem>
      <para>
       在<guimenu>绑定用户的 DN</guimenu> 和<guimenu>绑定用户的口令</guimenu>中，指定您要以其名称绑定到 LDAP 目录的用户的判别名 (DN) 和口令。
      </para>
      <para>
       或者，您也可以将这两个文本框留空，以匿名方式绑定到服务器（如果服务器支持此方式）。
      </para>
      <warning>
       <title>在不加密的情况下进行身份验证</title>
       <para>
        如果未启用通过 TLS 或 StartTLS 进行传输加密的功能，使用身份验证时将以明文形式传输口令。
       </para>
       
      </warning>
     </listitem>
    </itemizedlist>
    <para>
     在<guimenu>扩展选项</guimenu>下，您可以另外配置 BIND 操作的超时。
    </para>
   </step>
   <step>
    <para>
     要检查 LDAP 连接是否正常工作，请单击<guimenu>测试连接</guimenu>。
    </para>
   </step>
   <step>
    <para>
     要退出对话框，请单击<guimenu>确定</guimenu>。然后等待设置完成。
    </para>
    <para>
     最后，单击<guimenu>完成</guimenu>。
    </para>
   </step>
  </procedure>
 </sect2>
</sect1>

 <sect1 xml:id="sec-security-ldap-data" os="sles;osuse">
  <title>手动管理 LDAP 数据</title>
   <para>
    <systemitem>openldap2-client</systemitem> 软件包提供的命令行工具（例如 <command>ldapsearch</command> 或 <command>ldapmodify</command>）可用于管理 LDAP 目录中的数据。不过，它们是一些低级工具且不易使用。有关其用法的细节，请参见相应的手册页和文档。
   </para>
 </sect1>

<sect1 xml:id="sec-security-ldap-info">
  <title>更多信息</title>
  <para>
   有关 389 目录服务器的详细信息，请参见 <link xlink:href="http://www.port389.org/docs/389ds/documentation.html"/> 中的上游文档。
  </para>
 </sect1>
</chapter>
