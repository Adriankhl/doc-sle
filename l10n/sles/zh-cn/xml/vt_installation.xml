<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="vt_installation.xml" version="5.0" xml:id="cha-vt-installation">
 <title>安装虚拟化组件</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker>
   </dm:bugtracker>
        <dm:translation>是</dm:translation>
      </dm:docmanager>
    </info>
    <para>
  根据安装范围，可能不会在您的系统上安装任何虚拟化工具。使用 YaST 模块<menuchoice>
  <guimenu>虚拟化</guimenu> <guimenu>安装超级管理程序和工具</guimenu></menuchoice>配置超级管理程序时，会自动安装这些工具。如果 YaST 中未提供此模块，请安装软件包 <package>yast2-vm</package>。
 </para>

 <sect1 xml:id="sec-vt-installation-kvm">
  <title>安装 KVM</title>

  <para>
   要安装 KVM 和 KVM 工具，请执行以下操作：
  </para>

  <procedure>
   <step>
    <para>
     确认是否已安装  <package>yast2-vm</package> 包是否已安装。此软件包是 YaST 的配置工具，可以简化虚拟化超级管理程序的安装过程。
    </para>
   </step>
   <step>
    <para>
     启动 YaST 并选择<menuchoice>
     <guimenu>虚拟化</guimenu> <guimenu>安装超级管理程序和工具</guimenu></menuchoice>。
    </para>
   </step>
   <step>
    <para>
     选择 <guimenu>KVM 服务器</guimenu>以安装最少量的 QEMU 工具。如果还需要基于 <systemitem class="library">libvirt</systemitem> 的管理堆栈，请选择 <guimenu>KVM 工具</guimenu>。使用<guimenu>接受</guimenu>确认。
    </para>
   </step>
   <step>
    <para>
     要为 VM Guest 启用正常网络功能，建议使用网桥。YaST 会建议自动在 VM 主机服务器上配置网桥。如果您同意执行此操作，请选择<guimenu>是</guimenu>，否则请选择<guimenu>否</guimenu>。
    </para>
   </step>
   <step>
    <para>
     安装完成后，您便可以开始设置 VM Guest。不需要重引导 VM 主机服务器。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-vt-installation-xen">
  <title>安装 Xen</title>

  <para>
   要安装 Xen 和 Xen 工具，请执行以下操作：
  </para>

  <procedure>
   <step>
    <para>
     启动 YaST 并选择<menuchoice>
     <guimenu>虚拟化</guimenu> <guimenu>安装超级管理程序和工具</guimenu></menuchoice>。
    </para>
   </step>
   <step>
    <para>
     选择 <guimenu>Xen 服务器</guimenu>以安装最少量的 Xen 工具。如果还需要基于 <systemitem class="library">libvirt</systemitem> 的管理堆栈，请选择 <guimenu>Xen 工具</guimenu>。使用<guimenu>接受</guimenu>确认。
    </para>
   </step>
   <step>
    <para>
     要为 VM Guest 启用正常网络功能，建议使用网桥。YaST 会建议自动在 VM 主机服务器上配置网桥。如果您同意执行此操作，请选择<guimenu>是</guimenu>，否则请选择<guimenu>否</guimenu>。
    </para>
   </step>
   <step>
    <para>
     安装完成后，您需使用 <emphasis>Xen 内核</emphasis>重引导计算机。
    </para>
    <tip>
     <title>默认引导内核</title>
     <para>
      如果一切按预期进行，请使用 YaST 更改默认引导内核，并将支持 Xen 的内核设置为默认内核。有关更改默认内核的详细信息，请参见<xref linkend="sec-grub2-yast2-config"/>。
     </para>
    </tip>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-vt-installation-containers">
  <title>安装容器</title>

  <para>
   要安装容器，请执行以下操作：
  </para>

  <procedure>
   <step>
    <para>
     启动 YaST 并选择<menuchoice>
     <guimenu>虚拟化</guimenu> <guimenu>安装超级管理程序和工具</guimenu></menuchoice>。
    </para>
   </step>
   <step>
    <para>
     选择 <guimenu>libvirt lxc 守护程序</guimenu>并单击<guimenu>接受</guimenu>以确认。
    </para>
   </step>



  </procedure>
 </sect1>
 <sect1 xml:id="sec-vt-installation-patterns">
  <title>模式</title>

  <para>
   可以使用 Zypper 和模式来安装虚拟化软件包。运行 <command>zypper in -t pattern</command>
   <replaceable>PATTERN</replaceable> 命令。可用模式包括：
  </para>

  <variablelist>
   <varlistentry>
    <term>KVM</term>
    <listitem>
     <itemizedlist mark="bullet" spacing="normal">
      <listitem>
       <para>
        <systemitem class="resource">kvm_server</systemitem>：为 KVM VM 主机服务器设置用于进行管理的 QEMU 工具
       </para>
      </listitem>
      <listitem>
       <para>
        <systemitem class="resource">kvm_tools</systemitem>：安装用于管理和监视 VM Guest 的 <systemitem class="library">libvirt</systemitem> 工具
       </para>
      </listitem>
     </itemizedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Xen</term>
    <listitem>
     <itemizedlist mark="bullet" spacing="normal">
      <listitem>
       <para>
        <systemitem class="resource">xen_server</systemitem>：为 Xen VM 主机服务器设置用于进行管理的 Xen 工具
       </para>
      </listitem>
      <listitem>
       <para>
        <systemitem class="resource">xen_tools</systemitem>：安装用于管理和监视 VM Guest 的 <systemitem class="library">libvirt</systemitem> 工具
       </para>
      </listitem>
     </itemizedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>容器</term>
    <listitem>
     <para>
      容器没有模式；请安装 <emphasis>libvirt-daemon-lxc</emphasis> 软件包。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>

 <sect1 xml:id="sec-vt-installation-ovmf">
  <title>安装 UEFI 支持</title>
  <para>
   UEFI 支持由 <emphasis>OVMF</emphasis>（<emphasis>开放虚拟机固件</emphasis>）提供。要启用 UEFI 引导，请先安装 <package>qemu-ovmf-x86_64</package> 或
   <package>qemu-uefi-aarch64</package> 软件包。
  </para>
  <para>
   系统会自动选择虚拟机使用的固件。自动选择是根据
   <package>qemu-ovmf-<replaceable>ARCH</replaceable></package> 软件包中的 *.json 文件做出的。<systemitem class="library">libvirt</systemitem> QEMU 驱动程序会在装载时分析这些文件，因此知道各种固件的功能。然后，当用户选择固件类型以及任何所需功能（例如，安全引导支持）时，<systemitem class="library">libvirt</systemitem> 能够找到符合用户要求的固件。
  </para>
  <para>
   例如，要指定支持安全引导的 EFI，请使用以下配置：
  </para>
<screen>
&lt;os firmware='efi'&gt;
 &lt;loader secure='yes'/&gt;
&lt;/os&gt;
</screen>
  <para>
   软件包 <package>qemu-ovmf-<replaceable>ARCH</replaceable></package> 中包含以下文件：
  </para>
<screen>
<prompt role="root">root # </prompt><command>rpm -ql qemu-ovmf-x86_64</command>
[...]
/usr/share/qemu/ovmf-x86_64-ms-code.bin
/usr/share/qemu/ovmf-x86_64-ms-vars.bin
/usr/ddshare/qemu/ovmf-x86_64-ms.bin
/usr/share/qemu/ovmf-x86_64-suse-code.bin
/usr/share/qemu/ovmf-x86_64-suse-vars.bin
/usr/share/qemu/ovmf-x86_64-suse.bin
[...]
</screen>
  <para>
   <filename>*-code.bin</filename> 文件是 UEFI 固件文件。<filename>*-vars.bin</filename> 文件是对应的变量储存映像，可用作每个 VM 的非易失性储存模板。首次创建 VM 时，<systemitem class="library">libvirt</systemitem> 会将指定的 <literal>vars</literal> 模板复制到每个 VM 路径的 <filename>/var/lib/libvirt/qemu/nvram/</filename> 下。名称中不包含 <literal>code</literal> 或 <literal>vars</literal> 的文件可用作单个 UEFI 映像。它们没有太大的作用，因为每次经过 VM 关开机周期后，UEFI 变量都不会保存。
  </para>
  <para>
   <filename>*-ms*.bin</filename> 文件包含存放在实际硬件上的 Microsoft 密钥。因此，在 <systemitem class="library">libvirt</systemitem> 中它们已配置为默认设置。同样，<filename>*-suse*.bin</filename> 文件包含预安装的 SUSE 密钥。还有一组不包含预安装密钥的文件。
  </para>
  <para>
   有关细节，请参见<xref linkend="vle-libvirt-inst-virt-install-ovmf"/>和<link xlink:href="http://www.linux-kvm.org/downloads/lersek/ovmf-whitepaper-c770f8c.txt"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec-vt-installation-nested-vms">
  <title>启用 KVM 中的嵌套式虚拟化支持</title>

  <important>
   <title>技术预览</title>
   <para>
    KVM 的嵌套式虚拟化仍为技术预览版。此版本是出于测试目的提供的，我们不提供相关支持。
   </para>
  </important>

  <para>
   嵌套式 Guest 是 KVM Guest 中运行的 KVM Guest。在描述嵌套式 Guest 时，我们会用到以下虚拟化层：
  </para>

  <variablelist>
   <varlistentry>
    <term>L0</term>
    <listitem>
     <para>
      运行 KVM 的裸机主机。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>L1</term>
    <listitem>
     <para>
      在 L0 上运行的虚拟机。由于它可以在另一个 KVM 上运行，因此称为 <emphasis>Guest 超级管理程序</emphasis>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>L2</term>
    <listitem>
     <para>
      在 L1 上运行的虚拟机。称为<emphasis>嵌套式 Guest</emphasis>。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   嵌套式虚拟化具有诸多优势。它可在以下场景中为您提供便利：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     在云环境中直接使用所选的超级管理程序管理您自己的虚拟机。
    </para>
   </listitem>
   <listitem>
    <para>
     将超级管理程序及其 Guest 虚拟机作为单个实体进行实时迁移。
    </para>
   </listitem>
   <listitem>
    <para>
     使用嵌套式虚拟化进行软件开发和测试。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   要暂时启用嵌套功能，请去除该模块，然后使用 <option>nested</option> KVM 模块参数重新装载该模块：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     对于 Intel CPU，请运行：
    </para>
<screen>
<prompt>tux &gt; </prompt><command>sudo</command> modprobe -r kvm_intel &amp;&amp; modprobe kvm_intel nested=1
</screen>
   </listitem>
   <listitem>
    <para>
     对于 AMD CPU，请运行：
    </para>
<screen>
<prompt>tux &gt; </prompt><command>sudo</command> modprobe -r kvm_amd &amp;&amp; modprobe kvm_amd nested=1
</screen>
   </listitem>
  </itemizedlist>

  <para>
   要永久启用嵌套功能，请根据您的 CPU，在 <filename>/etc/modprobe.d/kvm_*.conf</filename> 文件中启用 <option>nested</option> KVM 模块参数：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     对于 Intel CPU，请编辑 <filename>/etc/modprobe.d/kvm_intel.conf</filename> 并添加下面一行：
    </para>
    <screen>options kvm_intel nested=Y</screen>
   </listitem>
   <listitem>
    <para>
     对于 AMD CPU，请编辑 <filename>/etc/modprobe.d/kvm_amd.conf</filename> 并添加下面一行：
    </para>
    <screen>options kvm_amd nested=Y</screen>
   </listitem>
  </itemizedlist>

  <para>
   如果 L0 主机能够嵌套，则您可以通过以下方式之一启动 L1 Guest：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     使用 <option>-cpu host</option> QEMU 命令行选项。
    </para>
   </listitem>
   <listitem>
    <para>
     将 <literal>vmx</literal>（对于 Intel CPU）或 <literal>svm</literal>（对于 AMD CPU）CPU 功能添加到 <option>-cpu</option> QEMU 命令行选项，用于启用虚拟 CPU 的虚拟化。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
