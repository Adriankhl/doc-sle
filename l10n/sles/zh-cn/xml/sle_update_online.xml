<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_online.xml" version="5.0" xml:id="cha-update-online">
 <title>联机升级</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    SUSE 提供了直观的图形工具和简单的命令行工具，供您将正在运行的系统升级到新服务包。它们提供<quote>回滚</quote>服务包支持及其他功能。本章将逐步介绍如何使用这些工具来执行服务包升级。
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec-update-migr-conceptual-overview">
  <title>概念概述</title>

  <para>
   在升级系统之前，请阅读<xref linkend="sec-update-prep"/>。
  </para>

  <para>
   SUSE 会定期发布用于 SUSE Linux Enterprise 系列的新服务包。为了方便客户迁移到新的服务包，并最大限度减少停机时间，SUSE 支持在系统运行时进行联机迁移。
  </para>

  <para>
   从 SLE 12 开始，YaST Wagon 已经由 YaST 迁移 (GUI) 和 Zypper 迁移（命令行）替代。系统支持以下功能：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     系统在首个 RPM 更新之前始终处于指定的状态
    </para>
   </listitem>
   <listitem>
    <para>
     在首个 RPM 更新之前可以取消
    </para>
   </listitem>
   <listitem>
    <para>
     如果出现错误可以轻松恢复
    </para>
   </listitem>
   <listitem>
    <para>
     通过系统工具<quote>回滚</quote>；不需要备份/恢复
    </para>
   </listitem>
   <listitem>
    <para>
     使用所有活动储存库
    </para>
   </listitem>
   <listitem>
    <para>
     可以跳过服务包
    </para>
   </listitem>
  </itemizedlist>

  <important>
   <title>升级 SUSE Manager 客户端</title>
   <para>如果要升级的系统是 SUSE Manager 客户端，则无法使用 YaST 在线迁移或 <command>zypper migration</command> 进行升级。请改为使用<citetitle>客户端迁移</citetitle>过程。<link xlink:href="https://documentation.suse.com/suma/"/> 上的《<citetitle>SUSE Manager Upgrade Guide</citetitle>》（SUSE Manager 升级指南）对此进行了说明。
   </para>
  </important>
 </sect1>
 <sect1 xml:id="sec-update-migr-workflow">
  <title>服务包迁移工作流程</title>

  <para>
   服务包迁移可通过 YaST、<command>zypper</command> 或 AutoYaST 执行。
  </para>

  <para>
   在开始服务包迁移之前，必须在 SUSE Customer Center 或本地 SMT 服务器中注册您的系统。也可以使用 SUSE Manager。
  </para>

  <para>
   不论使用哪种方式，服务包迁移都包含以下步骤：
  </para>

  <orderedlist>
   <listitem>
    <para>
     在注册系统中查找可能的迁移目标。
    </para>
   </listitem>
   <listitem>
    <para>
     选择一个迁移目标。
    </para>
   </listitem>
   <listitem>
    <para>
     请求并启用新的储存库。
    </para>
   </listitem>
   <listitem>
    <para>
     运行迁移。
    </para>
   </listitem>
  </orderedlist>



  <para>
   迁移目标列表取决于您所安装和注册的产品。如果您安装的扩展没有新的 SP 可用，则无法向您提供迁移目标。
  </para>

  <para>
   主机可用的迁移目标列表将始终从 SUSE Customer Center 检索，并与安装的产品或扩展相关。
  </para>
 </sect1>
 <sect1 xml:id="sec-update-migr-cancel-spm">
  <title>取消服务包迁移</title>

  <para>
   服务包迁移只能在迁移过程中的特定阶段取消：
  </para>

  <orderedlist>
   <listitem>
    <para>
     包升级过程开始之前，系统上只有极小的更改，例如服务和储存库的更改。恢复 <filename>/etc/zypp/repos.d/*</filename> 以便还原到之前的状态。
    </para>
   </listitem>
   <listitem>
    <para>
     包升级过程开始之后，可以使用 Snapper 快照（请参见<xref linkend="cha-snapper"/>）还原到之前的状态。
    </para>
   </listitem>
   <listitem>
    <para>
     选择迁移目标之后，SUSE Customer Center 更改了储存库数据。要手动还原此状态，请使用 <command>SUSEConnect</command>
     <option> --rollback</option>。
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 xml:id="sec-update-migr-yast-onlinemigr">
  <title>使用联机迁移工具 (YaST) 升级</title>

  <para>
   要通过 YaST 执行服务包迁移，请使用<guimenu>联机迁移</guimenu>工具。默认情况下，YaST 不会从第三方储存库安装任何包。如果某包是从第三方储存库安装的，YaST 会阻止该包替换成来自 SUSE 的相同包。
  </para>

  <note>
   <title>减少安装大小</title>
   <para>
    执行服务包迁移时，YaST 会安装所有推荐的包。特别是在自定义最小安装的情况下，这样可能会大幅增加系统的安装大小。
   </para>
   <para>
    要更改此默认行为并只允许必要的包，请调整 <filename>/etc/zypp/zypp.conf</filename> 中的 <option>solver.onlyRequires</option> 选项。
   </para>
<screen>solver.onlyRequires = true</screen>
   <para>
    另外，请编辑文件 <filename>/etc/zypp/zypper.conf</filename> 并更改 <option>installRecommends</option> 选项。
   </para>
   <screen>installRecommends=false</screen>
</note>

  <para>
   这会更改所有与包相关操作的行为，例如安装增补程序或新包的行为。
  </para>

  <para>
   要开始服务包迁移，请执行以下操作：
  </para>

  <procedure xml:id="pro-update-migr-yast">
   <step>
    <para>
     停用注册服务器上所有未使用的扩展，以免将来发生依赖性冲突。YaST 稍后会检测未使用的扩展储存库并将其停用，以防您忘记了某个扩展。
    </para>
   </step>
   <step>
    <para>
     如果您已登录到要更新的计算机上某个正在运行的 GNOME 会话，请切换到文本控制台。建议不要从 GNOME 会话运行更新。请注意，这并不适用于从远程计算机登录的情况（除非您正在使用 GNOME 运行 VNC 会话）。
    </para>
   </step>
   <step>
    <para>
     如果您是 LTSS 订购者，则必须禁用 LTSS 储存库。此操作无法通过 YaST 完成。请改为运行以下命令并指定已安装储存库的版本号：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> SUSEConnect -d -p SLES-LTSS/<replaceable>12.2</replaceable>/x86_64
<prompt>tux &gt; </prompt><command>sudo</command> zypper ref -s
</screen>
<para>
    有关详细信息，请参见支持公告“<citetitle>zypper migration with LTSS repo results in "No migration available"</citetitle>”（使用 LTSS 储存库执行 zypper migration 导致“没有可用的迁移”错误），网址为 <link xlink:href="https://www.suse.com/support/kb/doc/?id=7022381"/>
</para>
   </step>
   <step>
    <para>
     安装包
     <package>yast2-migration</package>
     及其依赖项（在 YaST 的<menuchoice>
     <guimenu>软件</guimenu> <guimenu> 软件管理</guimenu>
     </menuchoice>下）。
    </para>
   </step>
   <step>
    <para>
     重启动 YaST；如果不重启动，新安装的模块将不会显示在控制中心中。
    </para>
   </step>
   <step>
    <para>
     在 YaST 中，选择<guimenu>联机迁移</guimenu>（根据要升级的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 版本，此模块会列于<guimenu>系统</guimenu>或<guimenu>软件</guimenu>类别下）。YaST 将显示可能的迁移目标和摘要。如果有多个迁移目标可用于系统，请从列表中选择一个。
    </para>
   </step>
   <step>
    <para>
     从列表中选择一个迁移目标，然后单击<guimenu>下一步</guimenu>继续。
    </para>
   </step>
   <step>
    <para>
     如果迁移工具提供更新储存库，建议单击<guimenu>是</guimenu>继续。
    </para>
   </step>
   <step>
    <para>
     <remark>toms 2015-09-09: FATE#319140</remark>如果“联机迁移”工具找到来自 DVD 或本地服务器的过时储存库，强烈建议您将其禁用。过时储存库来自上一个服务包。来自 SCC 或 SMT 的所有旧储存库会自动去除。
    </para>
   </step>
   <step>
    <para>
     单击<guimenu>下一步</guimenu>，查看摘要并继续迁移过程。确认<guimenu>开始更新</guimenu>。
    </para>
    <remark>toms 2016-07-13: What to do in case of problems?</remark>
   </step>
   <step>
    <para>
     成功迁移后，请重启动系统。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-update-migr-zypper-onlinemigr">
  <title>使用 Zypper 升级</title>

  <para>
   要用 Zypper 执行服务包迁移，请使用命令行工具 <command>zypper</command> <option>migration</option>（来自包
   <package>zypper-migration-plugin</package>）。
  </para>

  <note>
   <title>减少安装大小</title>
   <para>
    执行服务包迁移时，YaST 会安装所有推荐的包。特别是在自定义最小安装的情况下，这样可能会大幅增加系统的安装大小。
   </para>
   <para>
    要更改此默认行为并只允许必要的包，请调整 <filename>/etc/zypp/zypp.conf</filename> 中的 <option>solver.onlyRequires</option> 选项。
   </para>
<screen>solver.onlyRequires = true</screen>
   <para>
    另外，请编辑文件 <filename>/etc/zypp/zypper.conf</filename> 并更改 <option>installRecommends</option> 选项。
   </para>
   <screen>installRecommends=false</screen>
  </note>

  <para>
   这会更改所有与包相关操作的行为，例如安装增补程序或新包的行为。要更改某次调用的 Zypper 行为，请在命令行上添加参数 <option>--no-recommends</option>。
  </para>

  <para>
   要开始服务包迁移，请执行以下操作：
  </para>

  <procedure xml:id="pro-update-migr-zypper">
   <step>
    <para>
     如果您已登录到要更新的计算机上某个正在运行的 GNOME 会话，请切换到文本控制台。建议不要从 GNOME 会话运行更新。请注意，这并不适用于从远程计算机登录的情况（除非您正在使用 GNOME 运行 VNC 会话）。
    </para>
   </step>
   <step>
    <para>
     注册 SUSE Linux Enterprise 计算机（如果尚未注册）：
    </para>
<screen>sudo <command>SUSEConnect</command> --regcode <replaceable>YOUR_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     如果您是 LTSS 订购者，则必须禁用 LTSS 储存库。请运行以下命令并指定已安装储存库的版本号：
    </para>
    <screen><prompt>tux &gt; </prompt><command>sudo</command> SUSEConnect -d -p SLES-LTSS/<replaceable>12.2</replaceable>/x86_64
<prompt>tux &gt; </prompt><command>sudo</command> zypper ref -s
</screen>
<para>
    有关详细信息，请参见支持公告“<citetitle>zypper migration with LTSS repo results in "No migration available"</citetitle>”（使用 LTSS 储存库执行 zypper migration 导致“没有可用的迁移”错误），网址为 <link xlink:href="https://www.suse.com/support/kb/doc/?id=7022381"/>
</para>
   </step>
   <step>
    <para>
     安装最新的更新：
    </para>
<screen>sudo <command>zypper</command> patch</screen>
   </step>
   <step>
    <para>
     安装 <package>zypper-migration-plugin</package> 包及其依赖项：
    </para>
<screen>sudo <command>zypper</command> in zypper-migration-plugin</screen>
   </step>
   <step>
    <para>
     运行 <command>zypper</command> <option> migration</option>：
    </para>
<screen><prompt>tux &gt; </prompt>sudo <command>zypper</command> migration
Executing 'zypper  patch-check'

Refreshing service 'SUSE_Linux_Enterprise_Server_12_x86_64'.
Loading repository data...
Reading installed packages...
0 patches needed (0 security patches)

Available migrations:

    1 | SUSE Linux Enterprise Server 12 SP1 x86_64
    2 | SUSE Linux Enterprise Server 12 SP2 x86_64</screen>
    <para>
     有关迁移过程的一些备注：
    </para>
    <itemizedlist>
     <listitem>
      <para>
       如果有多个迁移目标可用于系统，Zypper 会让您从列表中选择一个服务包。这与跳过一个或多个服务包一样。请注意，基础产品（SLES、SLED）的联机迁移仍然只适用于在主要版本的服务包之间进行。
      </para>
     </listitem>
     <listitem>
      <para>
       默认情况下，Zypper 会使用 <option>--no-allow-vendor-change</option> 选项，以传递到 <command>zypper</command> <option>dup</option>。如果某包是从第三方储存库安装的，此选项会阻止该包替换成来自 SUSE 的相同包。
      </para>
     </listitem>
     <listitem>
      <para>
       <remark>toms 2015-09-09: FATE#319140</remark>如果 Zypper 找到来自 DVD 或本地服务器的过时储存库，强烈建议您将其禁用。旧的 SCC 或 SMT 储存库会自动去除。
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     查看所有更改，特别是即将去除的包。键入 <literal>y</literal>（要升级的包的确切数目会根据系统的不同而变化）继续：
    </para>
<screen>266 packages to upgrade, 54 to downgrade, 17 new, 8 to reinstall, 5 to remove, 1 to change arch.
Overall download size: 285.1 MiB. Already cached: 0 B  After the operation, additional 139.8 MiB will be used.
Continue? [y/n/? shows all options] (y):</screen>
    <para>
     使用 <keycombo> <keycap function="shift"/> <keycap function="pageup"/>
     </keycombo> 或 <keycombo> <keycap function="shift"/>
     <keycap function="pagedown"/> </keycombo> 键在外壳中滚动。
    </para>
   </step>
   <step>
    <para>
     成功迁移后，请重启动系统。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-update-migr-plainzypper-onlinemigr">
  <title>使用 Plain Zypper 升级</title>

  <para>
   如果不能使用 YaST 迁移或 Zypper 迁移，您仍可以单纯通过 Zypper 并执行一些人工交互进行迁移。要开始服务包迁移，请执行以下操作：
  </para>

  <procedure>
   <step>
    <para>
     如果您已登录到要更新的计算机上某个正在运行的 GNOME 会话，请切换到文本控制台。建议不要从 GNOME 会话运行更新。请注意，这并不适用于从远程计算机登录的情况（除非您正在使用 GNOME 运行 VNC 会话）。
    </para>
   </step>
   <step>
    <para>
     用旧 SUSE Linux Enterprise 储存库更新包管理工具：
    </para>
<screen>sudo <command>zypper</command> patch --updatestack-only</screen>
   </step>
   <step>
    <para>
     如果系统已注册，则需要先取消注册：
    </para>
<screen>sudo <command>SUSEConnect</command> --de-register</screen>
   </step>
   <step>
    <para>
     去除旧安装源和储存库，并调整第三方储存库。
    </para>
   </step>
   <step>
    <para>
     添加新的安装源，不论是本地的还是远程的（有关占位符 <replaceable>REPOSITORY</replaceable>，请参考<xref linkend="sec-update-nmm-repositories"/>）：
    </para>
<screen>sudo <command>zypper</command> addrepo <replaceable>REPOSITORY</replaceable></screen>
    <para>
     您也可以使用 SUSE Customer Center 或订阅管理工具。在 x86-64 上用于 SUSE Linux Enterprise 12 SP1 的命令为：
    </para>
<screen>sudo <command>SUSEConnect</command> -p SLES/12.2/x86_64 <replaceable>OPTIONS</replaceable></screen>
    <para>
     请注意，系统不支持跨体系结构升级。
    </para>
    <para>
     Zypper 将显示新旧内核之间的冲突。选择解决方案 1 继续。
    </para>
<screen>Problem: product:SLES-12.2-0.x86_64 conflicts with kernel &lt; 4.4 provided by kernel-default-<replaceable>VERSION</replaceable>
 Solution 1: Following actions will be done:
  replacement of kernel-default-<replaceable>VERSION</replaceable> with kernel-default-<replaceable>VERSION</replaceable>
  deinstallation of kernel-default-<replaceable>VERSION</replaceable>
 Solution 2: do not install product:SLES-12.2-0.x86_64
</screen>
   </step>
   <step>
    <para>
     完成迁移：
    </para>
<screen>sudo <command>zypper</command> ref -f -s
sudo <command>zypper</command> dup --no-allow-vendor-change --no-recommends</screen>
    <para>
     第一个命令会更新所有服务和储存库。第二个命令会执行发行套件升级。在这里，最后两个选项比较重要：<option>-no-allow-vendor-change</option> 确保第三方 RPM 不会重写基础系统中的 RPM。<option>--no-recommends</option> 选项可确保初始安装过程中取消选择的包不会再次被添加。
    </para>
   </step>
  </procedure>
 </sect1>



 <sect1 xml:id="sec-update-migr-rollback">
  <title>回滚服务包</title>

  <para>
   如果服务包对于您而言不起作用，则 SUSE Linux Enterprise 支持将系统恢复到开始服务包迁移之前的状态。前提是对 Btrfs 根分区启用了快照（这是安装 SLES 12 时的默认设置）。有关详细信息，请参见<xref linkend="cha-snapper"/>。
  </para>

  <procedure xml:id="pro-update-migr-rollback">
   <step>
    <para>
     获取所有 Snapper 快照的列表：
    </para>
    <screen>sudo snapper list</screen>
    <para>
     查看输出以找到在开始服务包迁移之前刚创建的快照。<guimenu>Description</guimenu> 列包含相应的声明，并且 <guimenu>Userdata</guimenu> 列中会将该快照标记为 <literal>important</literal>。记住 <guimenu>#</guimenu> 列中的快照编号，以及 <guimenu>Date</guimenu> 列中该快照的日期。
    </para>
   </step>
   <step>
    <para>
     重引导系统。从引导菜单中选择<guimenu>从只读快照启动引导加载程序</guimenu>，然后选择上一步中记下的日期和编号所对应的快照。此时会装载第二个引导菜单（快照中的那个）。选择以 <literal>SLES 12</literal> 开头的项并引导它。
    </para>
   </step>
   <step>
    <para>
     系统会引导到先前的状态，并且系统分区会以只读方式装入。以 <systemitem class="username">root</systemitem> 身份登录，并检查您是否选择了正确的快照。另外，请确保一切如常。请注意，由于根文件系统是以只读方式装入的，因此功能可能受限。
    </para>
    <para>
     如果出现问题，或者您引导了错误的快照，请重新引导并选择从另一个快照引导 — 到此为止，系统尚未进行任何永久更改。如果快照正确并且按预期工作，请运行以下命令让更改永久生效：
    </para>
    <screen>snapper rollback</screen>
    <para>
     然后重引导。在引导屏幕上，选择默认的引导项以重引导至恢复后的系统。
    </para>
   </step>
   <step>
    <para>
     检查是否已正确重设置储存库配置。另外，检查是否所有产品均已正确注册。如果以上任何一项不正确，则稍后可能无法再有效地执行系统更新，或者可能会使用错误的包储存库更新系统。
    </para>
    <para>
     请先确保系统可以访问因特网，再开始此过程。
    </para>
    <substeps>
     <step>
      <para>
       运行以下命令以刷新服务和储存库：
      </para>
      <screen>sudo zypper ref -fs</screen>
     </step>
     <step>
      <para>
       运行以下命令以获得活动的储存库列表：
      </para>
      <screen>sudo zypper lr</screen>
      <para>
       仔细检查此命令的输出。为此次更新添加的服务和储存库不应该包含在列表中。举例来说，如果您要对从 SLES 12 SP1 到 SLES 12 SP2 的服务包迁移进行回滚，则列表<emphasis>不</emphasis>得包含储存库 <literal>SLES12-SP2-Pool</literal> 和 <literal>SLES12-SP2-Updates</literal>，而应包含 <literal>SP1</literal> 版本。
      </para>
      <para>
       如果列出了错误的储存库，请将其删除，必要时，请用与您的产品或服务包版本匹配的版本替换它们。有关受支持迁移路径的储存库列表，请参见<xref linkend="sec-update-nmm-repositories"/>。
      </para>
     </step>
     <step>
      <para>
       最后，通过运行以下命令检查所有已安装产品的注册状态：
      </para>
      <screen>SUSEConnect --status</screen>
      <para>
       所有产品都应该报告为<literal>已注册</literal>。若非如此，请运行以下命令修复注册：
      </para>
      <screen>SUSEConnect --rollback</screen>
     </step>
    </substeps>
   </step>
  </procedure>
  <para>
   现在，您已成功将系统恢复到就在开始服务包迁移之前捕获的状态。
  </para>
 </sect1>
</chapter>
