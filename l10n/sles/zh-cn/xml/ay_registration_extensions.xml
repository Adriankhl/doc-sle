<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ay_registration_extensions.xml" version="5.0" xml:id="CreateProfile-Register" os="sles;sled">
  <title>系统注册和扩展选择</title>

 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker/>
        <dm:translation>是</dm:translation>
      </dm:docmanager>
    </info>
    <para>
    可以在 <literal>suse_register</literal> 资源中配置于注册服务器中注册系统的操作。以下示例显示在 SUSE Customer Center 中注册系统。如果您的组织提供有自己的注册服务器，则您需要使用 <literal>reg_server*</literal> 属性指定所需的数据。有关细节，请参见下表。
   </para>

<screen>&lt;suse_register&gt;
  &lt;do_registration config:type="boolean"&gt;true&lt;/do_registration&gt;
  &lt;email&gt;tux@example.com&lt;/email&gt;
  &lt;reg_code&gt;<replaceable>MY_SECRET_REGCODE</replaceable>&lt;/reg_code&gt;
  &lt;install_updates config:type="boolean"&gt;true&lt;/install_updates&gt;
  &lt;slp_discovery config:type="boolean"&gt;false&lt;/slp_discovery&gt;
  &lt;--! optionally register some add-ons --&gt;
  &lt;addons config:type="list"&gt;
    &lt;addon&gt;
      &lt;name&gt;sle-module-basesystem&lt;/name&gt;
      &lt;version&gt;15.2&lt;/version&gt;
      &lt;arch&gt;<replaceable>x86_64</replaceable>&lt;/arch&gt;
    &lt;/addon&gt;
  &lt;/addons&gt;
&lt;/suse_register&gt;
 </screen>

   <para>
    建议至少注册 Basesystem 模块，以便能够访问基础系统（Linux 内核、系统库和服务）的更新。
   </para>

   <para>
    作为全自动注册的替代方法，还可将 AutoYaST 配置为在安装期间启动 YaST 注册模块。这样就可以手动输入注册数据。需要提供以下 XML 代码：
   </para>

<screen>&lt;general&gt;
 &lt;semi-automatic config:type="list"&gt;
   &lt;semi-automatic_entry&gt;scc&lt;/semi-automatic_entry&gt;
 &lt;/semi-automatic&gt;
&lt;/general&gt;</screen>

   <tip>
    <title>使用安装网络设置</title>
    <para>
     如果您要使用安装时所用的相同网络设置，AutoYaST 需要在启动注册前的第 1 阶段运行网络设置：
    </para>
<screen>&lt;networking&gt;
  &lt;setup_before_proposal config:type="boolean"&gt;true&lt;/setup_before_proposal&gt;
&lt;/networking&gt;</screen>
   </tip>

   <informaltable>
    <tgroup cols="3">
		<colspec colwidth="15*"/>
		<colspec colwidth="25*"/>
		<colspec colwidth="15*"/>
     <thead>
      <row>
       <entry>
        <para>
         元素
        </para>
       </entry>
       <entry>
        <para>
         说明
        </para>
       </entry>
       <entry>
        <para>
         注释
        </para>
       </entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>
        <para>
         <literal>do_registration</literal>
        </para>
       </entry>
       <entry>
        <para>
         布尔
        </para>
<screen>&lt;do_registration config:type="boolean"
&gt;true&lt;/do_registration&gt;</screen>
       </entry>
       <entry>
        <para>
         指定是否应注册系统。如果设置为 <literal>false</literal>，则会忽略所有其他选项，并且不注册系统。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <literal>e-mail</literal>
        </para>
       </entry>
       <entry>
        <para>
         电子邮件地址
        </para>
<screen>&lt;email&gt;tux@example.com&lt;/email&gt;</screen>
       </entry>
       <entry>
        <para>
         可选。与注册代码匹配的电子邮件地址。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <literal>reg_code</literal>
        </para>
       </entry>
       <entry>
        <para>
         文本
        </para>
<screen>&lt;reg_code&gt;<replaceable>SECRET_REGCODE</replaceable>&lt;/reg_code&gt;</screen>
       </entry>
       <entry>
        <para>
         必要。注册代码。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <literal>install_updates</literal>
        </para>
       </entry>
       <entry>
        <para>
         布尔
        </para>
<screen>&lt;install_updates config:type="boolean"
&gt;true&lt;/install_updates&gt;</screen>
       </entry>
       <entry>
        <para>
         可选。确定是否应安装来自“更新”频道的更新。默认为不安装这些更新 (<literal>false</literal>)。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <literal>slp_discovery</literal>
        </para>
       </entry>
       <entry>
        <para>
         布尔
        </para>
<screen>&lt;slp_discovery config:type="boolean"
&gt;true&lt;/slp_discovery&gt;</screen>
       </entry>
       <entry>
        <para>
         可选。通过 SLP 搜索注册服务器。默认值为 <literal>false</literal>。
        </para>
        <para>
         预期会查找单个服务器。如果找到多个服务器，安装将会失败。如果有多个可用的注册服务器，您需要使用 <literal>reg_server</literal> 指定一个服务器。
        </para>
        <para>
         如果 <literal>slp_discovery</literal> 和 <literal>reg_server</literal> 都未设置，将在 SUSE Customer Center 中注册系统。
        </para>
        <para>
         此设置也会影响自我更新功能：如果禁用此设置，将不执行 SLP 搜索。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <literal>reg_server</literal>
        </para>
       </entry>
       <entry>
        <para>
         URL
        </para>
<screen>&lt;reg_server&gt;
  https://smt.example.com
&lt;/reg_server&gt;</screen>
       </entry>
       <entry>
        <para>
         可选。RMT 服务器 URL。如果 <literal>slp_​discovery</literal> 和 <literal>reg_​server</literal> 都未设置，将在 SUSE Customer Center 中注册系统。
        </para>
        <para>
         将从 RMT 服务器查询自我更新储存库的 URL。因此，如果未设置 <literal>self_​update_​url</literal>，RMT 服务器将影响自我更新的下载位置。有关此功能的更多信息，请查看<citetitle>部署指南</citetitle>。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <literal>reg_server_cert_​fingerprint_type</literal>
        </para>
       </entry>
       <entry>
        <para>
         <literal>SHA1</literal> 或 <literal>SHA256</literal>
        </para>
<screen>&lt;reg_server_cert_fingerprint_type&gt;
  SHA1
&lt;/reg_server_cert_fingerprint_type&gt;</screen>
       </entry>
       <entry>
        <para>
         可选。需要通过 <literal>reg_​server_​cert_​fingerprint</literal> 提供校验和值。建议使用指纹，因为它可以确保 SSL 证书经过校验。当 SSL 通讯由于校验错误而失败时，将自动导入匹配的证书。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <literal>reg_​server_​cert_​fingerprint</literal>
        </para>
       </entry>
       <entry>
        <para>
         采用十六进制表示法（不区分大小写）的服务器证书指纹值。
        </para>
<screen>&lt;reg_server_cert_fingerprint&gt;
  <replaceable>01:AB...:EF</replaceable>
&lt;/reg_server_cert_fingerprint&gt;</screen>
       </entry>
       <entry>
        <para>
         可选。需要通过 <literal>reg_​server_​cert_​fingerprint_​type</literal> 提供指纹类型值。建议使用指纹，因为它可以确保 SSL 证书经过校验。当 SSL 通讯由于校验错误而失败时，将自动导入匹配的证书。
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <literal>reg_​server_​cert</literal>
        </para>
       </entry>
       <entry>
        <para>
         URL
        </para>
<screen>&lt;reg_server_cert&gt;
  http://smt.example.com/smt.crt
&lt;/reg_server_cert&gt;</screen>
       </entry>
       <entry>
        <para>
         可选。服务器上 SSL 证书的 URL。不建议使用此选项，因为不会校验下载的证书。请改用 <literal>reg_​server_​cert_​fingerprint</literal>。
        </para>
       </entry>
      </row>
      <row os="sles;sled">
       <entry>
        <para>
         <literal>addons</literal>
        </para>
       </entry>
       <entry>
        <para>
         附加产品列表
        </para>
       </entry>
       <entry>
        <para>
         指定应添加到安装储存库的注册服务器中的扩展。有关详细信息，请参见<xref linkend="CreateProfile-Register-Extension"/>。
        </para>
       </entry>
      </row>
     </tbody>
    </tgroup>
   </informaltable>

   <tip>
    <title>获取服务器证书指纹</title>
    <para>
     要获取与 <literal>reg_server_cert_fingerprint</literal> 项配合使用的服务器证书指纹，请在 SMT 服务器上运行以下命令（如果需要，请编辑 <filename>smt.crt</filename> 文件的默认路径）：
    </para>
<screen>openssl x509 -noout -in /srv/www/htdocs/smt.crt -fingerprint -sha256</screen>
    <para>
     要从 SMT 服务器检索指纹，请使用以下命令：
    </para>
<screen>curl --insecure -v https://scc.suse.com/smt.crt 2&gt; /dev/null | openssl
x509 -noout -fingerprint -sha256</screen>
     <para>
     请将 <literal>scc.suse.com</literal> 替换为您的服务器。
    </para>
    <para>
     <emphasis>注意：</emphasis>只能在可信网络中使用此命令！在不可信的网络（例如因特网）中，应通过其他方式直接从服务器获取指纹。可通过 SSH、保存的服务器配置和其他源提取指纹。或者，您也可以校验下载的证书是否与服务器上的证书相同。
    </para>
   </tip>

   <sect2 xml:id="CreateProfile-Register-Extension" os="sles;sled">
    <title>扩展</title>
    <para>
     SUSE Customer Center 提供多个扩展，例如 <literal>sle-module-development-tools</literal>（开发工具模块），在安装期间，可作为附加源包含这些扩展。可通过 <literal>suse_register</literal> 块中的 <literal>addons</literal> 属性添加扩展。
     
    </para>
    <note>
     <title>扩展可用性</title>
     <para>
      扩展的可用性与产品和体系结构有关，并非所有扩展都可在所有体系结构上使用。
      
     </para>
     <para>
      某些扩展（例如 <literal>sle-ha</literal>）需要注册代码。根据您的订阅，请使用扩展的专用注册代码，或者重申基础产品的注册代码。
     </para>
    </note>

    <para>
     使用 <command>SUSEConnect --list-extensions</command> 可以列出已注册系统中所有可用的扩展。结果包含如下几行：
    </para>
    <screen>Install with: SUSEConnect -p sle-module-development-tools/15.2/x86_64</screen>
    <para>
     <option>-p</option> 参数显示可在 AutoYaST 配置文件中使用的 <replaceable>NAME/VERSION/ARCH</replaceable> 值，如下所示：
    </para>
    <screen>&lt;addons config:type="list"&gt;
 &lt;addon&gt;
  &lt;!-- Development Tools Module --&gt;
  &lt;name&gt;sle-module-development-tools&lt;/name&gt;
  &lt;version&gt;15.2&lt;/version&gt;
  &lt;arch&gt;x86_64&lt;/arch&gt;
 &lt;/addon&gt;
&lt;/addons&gt;</screen>

<note>
 <title>扩展依赖项</title>
 <para>
   从 SLES 15 开始，在注册期间，AutoYaST 会根据扩展的依赖项对扩展进行重新排序。这意味着，AutoYaST 配置文件中的扩展顺序并不重要。
 </para>
 <para>
   另外，AutoYaST 会自动注册依赖扩展，即使这些扩展在配置文件中缺失也会如此。这意味着，您不需要填写整个扩展列表。
 </para>
 <para>
   但是，如果依赖扩展需要注册密钥，则必须在配置文件中指定这一点（包括该注册密钥）。否则注册将会失败。
 </para>
</note>

    <para>
     有关背景信息和 SLES 的附加产品列表，请参见 <link xlink:href="https://github.com/yast/yast-registration/wiki/Available-SCC-Extensions-for-Use-in-Autoyast"/>。附加产品列表会不时更新。
    </para>
   </sect2>
  </sect1>
