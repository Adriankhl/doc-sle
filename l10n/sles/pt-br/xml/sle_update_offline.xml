<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_offline.xml" version="5.0" xml:id="cha-upgrade-offline">
 <title>Fazendo upgrade offline</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes (sim)</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    Este capítulo descreve como fazer upgrade de uma instalação existente do SUSE Linux Enterprise com o YaST, que é inicializado de um meio de instalação. Por exemplo, o instalador do YaST pode ser iniciado de um DVD, pela rede, ou do disco rígido no qual o sistema reside.
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec-upgrade-offline-conceptual-overview">
  <title>Visão geral conceitual</title>
  <para>
   Antes de fazer upgrade do sistema, leia primeiro o <xref linkend="cha-update-preparation"/>.
  </para>
  <para>
   Para fazer upgrade do sistema, execute a inicialização de uma fonte de instalação, do mesmo modo que em uma instalação nova. Porém, quando a tela de boot aparecer, você deverá selecionar <guimenu>Upgrade</guimenu> (em vez de <guimenu>Instalação</guimenu>). O upgrade pode ser iniciado de:
  </para>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>Mídia removível</title>
     <para>
      Isso inclui mídia, como CDs, DVDs ou dispositivos de armazenamento em massa USB. Para obter mais informações, consulte a <xref linkend="sec-upgrade-offline-dvd"/>.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Recurso de rede</title>
     <para>
      É possível inicializar do meio local e, em seguida, selecionar o respectivo tipo de instalação de rede, ou inicializar via PXE. Para obter mais informações, consulte a <xref linkend="sec-upgrade-offline-network"/>.
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>
 </sect1>


 <sect1 xml:id="sec-upgrade-offline-dvd">
  <title>Iniciando o upgrade do meio de instalação</title>
  <para>
   O procedimento a seguir descreve a inicialização de um DVD, mas você também pode usar outro meio de instalação local, como uma imagem ISO em um dispositivo de armazenamento em massa USB. O método de seleção de meio e de boot depende da arquitetura do sistema e se a máquina tem BIOS tradicional ou UEFI.
  </para>
  <procedure xml:id="pro-update-sle12-offline-dvd">
   <title>Fazendo upgrade manualmente do SLE 11 SP4 para o SLE 12 SP3</title>
   <step>
    <para>
     Selecione e prepare um meio de boot. Consulte a <xref linkend="part-prep"/>.
    </para>
   </step>
   <step>
    <para>
     Insira o DVD 3 do meio de instalação do SUSE Linux Enterprise 12 SP1 e inicialize a máquina. Uma tela de <guimenu>boas-vindas</guimenu> aparece seguida da tela de boot.
    </para>
   </step>
   <step>
    <para>
     Inicialize o sistema selecionando <emphasis>Fazer Upgrade</emphasis> no menu de boot.
    </para>
   </step>
   <step>
    <para>
     Prossiga com o processo de upgrade conforme descrito na <xref linkend="sec-upgrade-offline-yast"/>.
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec-upgrade-offline-network">
  <title>Iniciando o upgrade da fonte de rede</title>
  <para>
   Para iniciar o upgrade de uma fonte de instalação de rede, você deve cumprir os seguintes requisitos:
  </para>
  <variablelist>
   <title>Requisitos para upgrade de uma fonte de instalação de rede</title>
   <varlistentry>
    <term>Fonte de Instalação de Rede</term>
    <listitem>
     <para>
      Configuração de uma fonte de instalação de rede de acordo com o <xref linkend="cha-deployment-instserver"/>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Conexão de Rede e Serviços de Rede</term>
    <listitem>
     <para>
      Ambos o servidor de instalação e a máquina de destino devem ter uma conexão de rede ativa. Os serviços de rede necessários são:
     </para>
     <itemizedlist>
      <listitem><para>Domain Name Service (Serviço de Nomes de Domínio)</para></listitem>
      <listitem><para>DHCP (Dynamic Host Configuration Protocol): necessário apenas para inicialização por PXE. O IP pode ser definido manualmente durante a configuração</para></listitem>
      <listitem><para>OpenSLP (opcional)</para></listitem>
     </itemizedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Meio de Boot</term>
    <listitem>
     <para>
      Um DVD do SUSE Linux Enterprise inicializável, uma imagem ISO ou uma configuração PXE funcionando. Para obter detalhes sobre como inicializar via PXE, consulte o <xref linkend="sec-deployment-prep-boot-pxeprep"/>. Consulte o <xref linkend="cha-remote-installation"/> para obter informações detalhadas sobre como iniciar o upgrade de um servidor remoto.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <sect2 xml:id="sec-update-sle-manual-network-boot-from-dvd">
   <title>Fazendo upgrade manualmente por meio da fonte de instalação de rede: inicialização do DVD</title>
   <para>
    Esse procedimento descreve a inicialização de um DVD, como exemplo, mas você também pode usar outro meio de instalação local, como uma imagem ISO em um dispositivo de armazenamento em massa USB. A maneira de selecionar o método de boot e inicializar o sistema do meio depende da arquitetura do sistema e se a máquina tem BIOS tradicional ou UEFI. Para obter detalhes, consulte os links a seguir.
   </para>
   <procedure xml:id="pro-update-sle-manual-network-boot-from-dvd">

    <step>
     <para>
      Insira o DVD 2 da mídia de instalação do SUSE Linux Enterprise 12 SP1 e inicialize a máquina. Uma tela de <guimenu>boas-vindas</guimenu> aparece seguida da tela de boot.
     </para>
    </step>
    <step>
     <para>
      Selecione o tipo de fonte de instalação de rede que deseja usar (FTP, HTTP, NFS, SMB ou SLP). Normalmente, você vê essa opção pressionando <keycap>F4</keycap>, mas caso sua máquina esteja equipada com UEFI, e não com um BIOS tradicional, talvez seja necessário ajustar os parâmetros de boot manualmente. Para obter os detalhes, consulte a <xref linkend="cha-boot-parameters"/> e a <xref linkend="cha-install"/>.
     </para>
    </step>
    <step>
     <para>
      Prossiga com o processo de upgrade conforme descrito na <xref linkend="sec-upgrade-offline-yast"/>.
     </para>
    </step>
   </procedure>
  </sect2>
  <sect2 xml:id="sec-update-sle-manual-network-pxe-boot">
   <title>Fazendo upgrade manualmente por meio da fonte de instalação de rede: inicialização via PXE</title>
   <para>
    Para fazer upgrade de uma fonte de instalação de rede usando o boot PXE, faça o seguinte:
   </para>
   <procedure xml:id="pro-update-sle-manual-network-pxe-boot">
    <step>
     <para>
      Ajuste a configuração do servidor DHCP para fornecer as informações de endereço necessárias à inicialização via PXE. Para obter os detalhes, consulte o <xref linkend="pro-deployment-dhcp-server"/>.
     </para>
    </step>
    <step>
     <para>
      Configure um servidor TFTP para manter a imagem de boot necessária à inicialização via PXE. Use o DVD 2 da mídia de instalação do SUSE Linux Enterprise 12 SP1 para isso ou siga as instruções no <xref linkend="sec-deployment-tftp-server"/>.
     </para>
    </step>
    <step>
     <para>
      Prepare o Boot PXE e o Wake-on-LAN na máquina de destino.
     </para>
    </step>
    <step>
     <para>
      Inicialize o sistema de destino e use o VNC para conectar-se remotamente à rotina de instalação que está sendo executada nessa máquina. Para obter mais informações, consulte o <xref linkend="sec-remote-installation-monitor-vnc"/>.
     </para>
    </step>
    <step>
     <para>
      Prossiga com o processo de upgrade conforme descrito na <xref linkend="sec-upgrade-offline-yast"/>.
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>

 <sect1 xml:id="sec-upgrade-offline-automated">
  <title>Habilitando o upgrade automático</title>
  <para>
   O processo de upgrade pode ser executado automaticamente. Para habilitar a atualização automática, o parâmetro do kernel <literal>autoupgrade=1</literal> deve ser definido. É possível definir o parâmetro durante a inicialização no campo <literal>Opções de Boot</literal>. Para obter os detalhes, consulte <link xlink:href="https://www.suse.com/documentation/sles-12/book_autoyast/data/introduction.html"/>.
  </para>
 </sect1>
 <sect1 xml:id="sec-upgrade-offline-yast">
  <title>Fazendo upgrade do SUSE Linux Enterprise</title>
  <para>
   <remark>taroth 2014-11-13: argh, the following is terminology hell regarding
     the software strings: "upgrade"/"update" are used intermittently and
     without clear differentiation...</remark>
  </para>
  <para>
   Antes de fazer upgrade do sistema, leia o <xref linkend="cha-update-preparation"/>. Para executar a migração automatizada, faça o seguinte:
  </para>
  <procedure>
   <step>
    <para>
     Após a inicialização (de um meio de instalação ou da rede), selecione a entrada <guimenu>Upgrade</guimenu> na tela de boot. Para fazer upgrade manualmente, conforme descrito nas próximas etapas, você precisa desabilitar o processo de upgrade automático. Consulte a <xref linkend="sec-upgrade-offline-automated"/>.
    </para>
    <warning>
     <title>A opção errada pode levar a perda de dados</title>
     <para>
      Se você selecionar <guimenu>Instalação</guimenu> em vez de <guimenu>Upgrade</guimenu>, poderá haver perda de dados posteriormente. É necessário tomar mais cuidado para não destruir suas partições de dados ao fazer uma instalação nova.
     </para>
     <para>
      Selecione <guimenu>Upgrade</guimenu> neste momento.
     </para>
    </warning>
    <para>
     O YaST inicia o sistema de instalação.
    </para>
   </step>
   <step>
    <para>
     Na tela <guimenu>Bem-vindo</guimenu>, escolha <guimenu>Idioma</guimenu> e <guimenu>Teclado</guimenu>. Continue com <guimenu>Avançar</guimenu>.
    </para>
    <para>
     O YaST verifica se já existem sistemas do SUSE Linux Enterprise instalados em suas partições.
    </para>
   </step>
   <step>
    <para>
     Na tela <guimenu>Select for Upgrade</guimenu> (Selecionar para Upgrade), selecione a partição para fazer upgrade e clique em <guimenu>Avançar</guimenu>.
    </para>
   </step>
   <step>
    <para>
     O YaST monta a partição selecionada e exibe o contrato de licença referente ao produto do qual foi feito o upgrade. Para continuar, aceite a licença.
    </para>
   </step>
   <step>
    <para>
     Na tela <guimenu>Repositórios Previamente Utilizados</guimenu>, ajuste o status dos repositórios: habilite os que deseja incluir no processo de upgrade e desabilite todos os repositórios que não são mais necessários. Continue com <guimenu>Avançar</guimenu>.
    </para>
   </step>
   <step>
    <para>
     A próxima etapa depende do registro do sistema do qual foi feito o upgrade.
    </para>
    <substeps>
     <step>
      <para>
       Se o sistema não foi registrado, o YaST exibe uma mensagem popup sugerindo o uso de um segundo meio de instalação: SLE-15-Packages.
      </para>
      <para>
       Se você não tem esse meio, o upgrade do sistema pode ser feito apenas para o SUSE Linux Enterprise 15 mínimo.
      </para>
     </step>
     <step>
      <para>
       Se o sistema foi registrado, o YaST mostra os destinos de migração possíveis e um resumo.
      </para>
      <para>
       Selecione um destino de migração na lista e clique em <guimenu>Avançar</guimenu> para continuar.
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     Na caixa de diálogo seguinte, você pode adicionar outro meio de instalação. Se você tem uma mídia de instalação adicional, ative a opção <guimenu>Eu desejo instalar outro Produto Complementar</guimenu> e especifique o tipo de mídia.
    </para>
   </step>
   <step>
    <para>
     Revise as <guimenu>Configurações de Instalação</guimenu> para o upgrade.
    </para>
   </step>
   <step>
    <para>
     Se todas as configurações estiverem conforme desejado, inicie o procedimento de instalação e remoção clicando em <guimenu>Atualizar</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Quando o processo de upgrade for concluído com êxito, verifique se há <quote>pacotes órfãos</quote>. Os pacotes órfãos são aqueles que não pertencem mais a nenhum repositório ativo. O comando a seguir fornece uma lista deles:
    </para>
<screen><prompt>tux &gt; </prompt>zypper packages --orphaned</screen>
    <para>
     Com essa lista, você pode decidir se um pacote ainda é necessário ou pode ser desinstalado com segurança.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-upgrade-offline-manager">
  <title>Atualizando pelo SUSE Manager</title>

  <para>
   O SUSE Manager é uma solução de servidor que oferece atualizações, patches e correções de segurança para clientes SUSE Linux Enterprise. Ele vem com um conjunto de ferramentas e uma interface do usuário baseada na Web para as tarefas de gerenciamento. Consulte <link xlink:href="https://www.suse.com/products/suse-manager/"/> para obter mais informações sobre o SUSE Manager.
  </para>
  
  <para>
   O SUSE Manager pode oferecer suporte a você para Migração de SP ou upgrade completo do sistema.
  </para>

  <variablelist>
   
   <varlistentry>
    <term>Migração de SP</term>
    <listitem>
     <para>
      A Migração de SP permite migrar de um Service Pack (SP) para outro dentro de uma versão principal (por exemplo, do SLES 12 SP1 para o 12 SP2). Para obter mais informações, consulte <citetitle>SUSE Manager Best Practices</citetitle> (Melhores práticas do SUSE Manager), capítulo <quote>Client Migration</quote> (Migração de cliente), seção <quote>Migrating SUSE Linux Enterprise Server 12 or later to version 12 SP2</quote> (Migrando o SUSE Linux Enterprise Server 12 ou posterior para a versão 12 SP2):
     </para>
     <para>
      
      <link xlink:href="https://www.suse.com/documentation/suse-manager/"/>, versão 3.1.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Upgrade do sistema</term>
    <listitem>
     <para>
      Com o SUSE Manager, é possível executar um upgrade do sistema. Com a tecnologia AutoYaST integrada, upgrades de uma versão principal para a próxima são possíveis (por exemplo, do SLES 11 SP3 para o 12 SP2). Para obter mais informações, consulte <citetitle>SUSE Manager Best Practices</citetitle> (Melhores práticas do SUSE Manager), capítulo <quote>Client Migration</quote> (Migração de cliente), seção <quote>Migrating SUSE Linux Enterprise 11 SP3 to version 12 SP2</quote> (Migrando o SUSE Linux Enterprise 11 SP3 para a versão 12 SP2):
     </para>
     <para>
      
      <link xlink:href="https://www.suse.com/documentation/suse-manager/"/>, versão 3.1.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-update-reg-status-after-rollback">
  <title>Atualizando o status do registro após o rollback</title>

  <para>
   Ao executar o upgrade de um pacote de serviço, é necessário mudar a configuração no servidor de registro para fornecer acesso aos novos repositórios. Se o processo de upgrade for interrompido ou revertido (por meio da restauração de um backup ou instantâneo), as informações sobre o servidor de registro ficarão inconsistentes com o status do sistema. Isso pode impedir você de acessar os repositórios de atualização ou fazer com que repositórios errados sejam usados no cliente.
  </para>

  <para>
   Quando um rollback é feito por meio do Snapper, o sistema notifica o servidor de registro para garantir que o acesso aos repositórios corretos seja configurado durante o processo de boot. Se o sistema foi restaurado com outro método ou houve falha na comunicação com o servidor de registro, acione manualmente o rollback no cliente. Um exemplo de acionamento manual de rollback pode ser quando o servidor não estava acessível por causa de problemas na rede. Para fazer um rollback, execute:
  </para>

<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>snapper</command> rollback</screen>

  <para>
   É recomendável verificar sempre se os repositórios corretos estão configurados no sistema, principalmente após a atualização do serviço com:
  </para>

<screen><prompt>tux &gt; </prompt><command>sudo</command> <command>zypper</command> ref -s</screen>

  <para>
   Essa funcionalidade está disponível no pacote
   <package>rollback-helper</package>
   pacote.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-registersystem">


  <title>Registrando seu sistema</title>

  <para>
   Se o sistema não foi registrado antes de executar o upgrade, você pode registrar o sistema a qualquer momento usando o módulo <guimenu>Registro de Produto</guimenu> do YaST.
  </para>

  <para>
   O registro de sistemas tem as seguintes vantagens:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Qualificação para suporte
    </para>
   </listitem>
   <listitem>
    <para>
     Disponibilidade de atualizações de segurança e correções de bug
    </para>
   </listitem>
   <listitem>
    <para>
     Acessar o SUSE Customer Center
    </para>
   </listitem>
  </itemizedlist>

  <procedure>
   <step>
    <para>
     Inicie o YaST e selecione <menuchoice> <guimenu>Software</guimenu> <guimenu>Registro de Produto</guimenu> </menuchoice> para abrir a caixa de diálogo <guimenu>Registro</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Informe o endereço de <guimenu>E-mail</guimenu> associado à conta do SUSE que você ou sua organização usa para gerenciar inscrições. Se você ainda não tem uma conta do SUSE, vá para a home page do SUSE Customer Center (<link xlink:show="new" xlink:href="https://scc.suse.com/"/>) para criar uma.
    </para>
   </step>
   <step>
    <para>
     Digite o <guimenu>Código de Registro</guimenu> que você recebeu com a cópia do <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>.
    </para>
   </step>
   <step>
     <para>
      Se houver um ou mais servidores de registro locais disponíveis na rede, você poderá escolher um deles na lista.
     </para>
   </step>
   <step xml:id="st-y2-register-final">
    <para>
     Para iniciar o registro, clique em <guimenu>Avançar</guimenu> para prosseguir.
    </para>
    <para>
     Após o registro bem-sucedido, o YaST mostrará uma lista de extensões, complementos e módulos disponíveis para o seu sistema. Para selecioná-los e instalá-los, continue no <xref linkend="sec-add-ons-extensions"/>.
    </para>
   </step>
  </procedure>
 </sect1>

</chapter>
