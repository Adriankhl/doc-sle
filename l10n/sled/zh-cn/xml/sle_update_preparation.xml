<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_preparation.xml" version="5.0" xml:id="cha-update-preparation">
 <title>Preparing the Upgrade</title>
 <info>
      <abstract>
        <para>
    Before starting the upgrade procedure, make sure your system is properly
    prepared. Among others, preparation involves backing up data and checking
    the release notes.
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:translation>no</dm:translation>
      </dm:docmanager>
    </info>
    <sect1 xml:id="sec-update-preparation-update">
  <title>Make Sure the Current System Is Up-To-Date</title>
  <para>
   Upgrading the system is only supported from the most recent
   patch level. Make sure the latest system updates are installed by either
   running <command>zypper patch</command> or by starting the YaST module
   <guimenu>Online-Update</guimenu>.
  </para>
 </sect1>

 <sect1 xml:id="sec-update-preparation-relnotes">
  <title>Read the Release Notes</title>
  <para>
   In the release notes you can find additional information on changes
   since the previous release of <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase>. Check the release notes
   to see whether:
  </para>
  <itemizedlist>
   <listitem>
    <para>
     your hardware needs special considerations;
    </para>
   </listitem>
   <listitem>
    <para>
     any used software packages have changed significantly;
    </para>
   </listitem>
   <listitem>
    <para>
     special precautions are necessary for your installation.
    </para>
   </listitem>
  </itemizedlist>
  <para>
   The release notes also provide information that could not make it
   into the manual on time. They also contain notes about known issues.
  </para>
  
  <para>
   Find the current release notes online at
   <link xlink:href="https://www.suse.com/releasenotes/"/>.
  </para>
  <para>
   Alternatively, find the release notes on the installation DVD in the
   <filename>docu</filename> directory.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-backup">
  <title>Make a Backup</title>
  <para>
   Before updating, copy existing configuration files to a separate medium
   (such as tape device, removable hard disk, etc.) to back up the data. This
   primarily applies to files stored in <filename>/etc</filename> and some
   directories and files in <filename>/var</filename> and
   <filename>/opt</filename>. You may also want to write the user data in
   <filename>/home</filename> (the <envar>HOME</envar> directories) to a
   backup medium. Back up this data as <systemitem class="username">root</systemitem>. Only <systemitem class="username">root</systemitem> has read
   permissions for all local files.
  </para>
  <para>
   If you have selected <guimenu>Update an Existing System</guimenu> as the
   installation mode in YaST, you can choose to do a (system) backup at a
   later point in time. You can choose to include all modified files and files
   from the <filename>/etc/sysconfig</filename> directory. However, this is
   not a complete backup, as all the other important directories mentioned
   above are missing. Find the backup in the
   <filename>/var/adm/backup</filename> directory.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-packagelist">
  <title>Listing Installed Packages and Repositories</title>
  <para>
   It is often useful to save a list of installed packages, for example
   when doing a fresh install of a new major SLE release or
   reverting to the old version.
  </para>
  <para>
   Be aware that not all installed packages or used repositories are
   available in newer releases of SUSE Linux Enterprise. Some may have been renamed and
   others replaced. It is also possible that some packages are still
   available for legacy purposes while another package is used by
   default. Therefore some manual editing of the files might be
   necessary. This can be done with any text editor.
  </para>
  <para>
   Create a file named <filename>repositories.bak.repo</filename> containing a
   list of all used repositories:
  </para>
  <screen><prompt role="root">root # </prompt><command>zypper</command> lr -e repositories.bak</screen>
  <para>
   Also create a file named <filename>installed-software.bak</filename>
   containing a list of all installed packages:
  </para>
  <screen><prompt role="root">root # </prompt><command>rpm</command> -qa --queryformat '%{NAME}\n' &gt; installed-software.bak</screen>
  <para>
   Back up both files. The repositories and installed packages can be
   restored with the following commands:
  </para>
  <screen><prompt role="root">root # </prompt><command>zypper</command> ar repositories.bak.repo
<prompt role="root">root # </prompt><command>zypper</command> install $(cat installed-software.bak)</screen>

  <note xml:id="note-update-prep-backup-package-amount">
   <title>
    Number of Packages Increases with an Update to a New Major Release
   </title>
   <para>
    A system upgraded to a new major version
    (SLE <replaceable>X+1</replaceable>) may contain more packages than
    the initial system (SLE <replaceable>X</replaceable>). It will also
    contain more packages than a fresh installation of
    SLE <replaceable>X+1</replaceable> with the same pattern
    selection. Reasons for this are:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Packages were split to allow a more fine-grained package selection. For
      example, 37 <package>texlive</package> packages on SLE 11 were split
      into over 3000 packages on SLE 15.
     </para>
    </listitem>
    <listitem>
     <para>
      When a package has been split, all new packages are
      installed in the upgrade case to retain the same functionality as with
      the previous version. However, the new default for a fresh installation
      of SLE <replaceable>X+1</replaceable> may be to not install all
      packages.
     </para>
    </listitem>
    <listitem>
     <para>
      Legacy packages from SLE <replaceable>X</replaceable> may be kept
      for compatibility reasons.
     </para>
    </listitem>
    <listitem>
     <para>
      Package dependencies and the scope of patterns may have changed.
     </para>
    </listitem>
   </itemizedlist>
  </note>
 </sect1>

 

 

 <sect1 xml:id="sec-update-preparation-vms">
  <title>Shut Down Virtual Machine Guests</title>
  <para>
   If your machine serves as a VM Host Server for KVM or Xen, make sure to
   properly shut down all running VM Guests prior to the update. Otherwise
   you may not be able to access the guests after the update.
  </para>
 </sect1>

 

  <sect1 xml:id="sec-update-preparation-rmt">
   <title>Adjusting Your SMT Client Setup</title>
   <para>
    If the machine you want to upgrade is registered as a client against an
    SMT server, take care of the following:
   </para>
   <para>
    Check if the version of the <command>clientSetup4SMT.sh</command> script on
    your host is up to date. <command>clientSetup4SMT.sh</command> from older
    versions of SMT cannot manage SMT 12 clients. If you apply software
    patches regularly on your SMT server, you can always find the latest version
    of <command>clientSetup4SMT.sh</command> at
    <filename>&lt;SMT_HOSTNAME&gt;/repo/tools/clientSetup4SMT.sh</filename>.
   </para>

   <para>
    In case upgrading your machine to a higher version of <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> fails,
    de-register the machine from the SMT server as described in
    <xref linkend="pro-sec-update-prep-smt-de-register" xrefstyle="select:label"/>.
    Afterward, restart the upgrade process.</para>
   <procedure xml:id="pro-sec-update-prep-smt-de-register">
    <title>De-registering a SUSE Linux Enterprise Client from an SMT Server</title>
     <step>
      <para>
       Log in to the client machine.
      </para>
     </step>
     <step>
     <para>The following step depends on the current operating system of the client:</para>
     <itemizedlist>
      <listitem>
       <para>
        For SUSE Linux Enterprise 11, execute the following commands:
       </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> suse_register -E
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/SUSEConnect
<prompt>tux &gt; </prompt><command>sudo</command> rm -rf /etc/zypp/credentials.d/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -rf /etc/zypp/repos.d/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/zypp/services.d/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /var/cache/SuseRegister/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/suseRegister*
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /var/cache/SuseRegister/lastzmdconfig.cache
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/zmd/deviceid
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/zmd/secret</screen>
      </listitem>
      <listitem>
       <para>
        For SUSE Linux Enterprise 12, execute the following commands:
       </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> SUSEConnect --de-register
<prompt>tux &gt; </prompt><command>sudo</command> SUSEConnect --cleanup
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/SUSEConnect
<prompt>tux &gt; </prompt><command>sudo</command> rm -rf /etc/zypp/credentials.d/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -rf /etc/zypp/repos.d/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/zypp/services.d/*</screen>
      </listitem>
     </itemizedlist>
    </step>
    <step>
     <para>
      Log in to the SMT server.
     </para>
    </step>
    <step>
     <para>
      Check if the client has successfully been de-registered by listing all
      client registrations:
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> smt-list-registrations</screen>
    </step>
    <step>
     <para>
      If the client's host name is still listed in the output of this command,
      get the client's <literal>Unique ID</literal> from the first column. (The
      client might be listed with multiple IDs.)
     </para>
    </step>
    <step>
     <para>
      Delete the registration for this client:
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> smt-delete-registration -g <replaceable>UNIQUE_ID</replaceable></screen>
    </step>
     <step>
     <para>
      If the client is listed with multiple IDs, repeat the step above for each
      of its unique IDs.
     </para>
    </step>
    <step>
     <para>
      Check if the client has now successfully been de-registered by re-running:
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> smt-list-registrations</screen>
    </step>
   </procedure>
  </sect1>

 <sect1 xml:id="sec-update-preparation-disk">
  <title>Disk Space</title>

  <para>
   Software tends to grow from version to version. Therefore,
   take a look at the available partition space before updating. If you suspect
   you are running short of disk space, back up your data before increasing the
   available space by resizing partitions, for example. There is no general
   rule regarding how much space each partition should have. Space requirements
   depend on your particular partitioning profile and the software selected.
  </para>

  <note>
   <title>Automatic Check for Enough Space in YaST</title>
   <para>
    During the update procedure, YaST will check how much free disk space is
    available and display a warning to the user if the installation may exceed
    the available amount. In that case, performing the update may lead to an
    <emphasis>unusable system</emphasis>! Only if you know exactly what you are
    doing (by testing beforehand), you can skip the warning and continue the
    update.
   </para>
  </note>

  <sect2 xml:id="sec-update-preparation-disk-space">
   <title>Checking Disk Space on Non-Btrfs File Systems</title>
   <para>
    Use the <command>df</command> command to list available disk space. For
    example, in <xref linkend="ex-update-df"/>, the root partition is
    <filename>/dev/sda3</filename> (mounted as <filename>/</filename>).
   </para>
   <example xml:id="ex-update-df">
    <title>List with <command>df -h</command></title>
<screen os="sled">Filesystem     Size  Used Avail Use% Mounted on
/dev/sda3       74G   22G   53G  29% /
tmpfs          506M     0  506M   0% /dev/shm
/dev/sda5      116G  5.8G  111G   5% /home
/dev/sda1       39G  1.6G   37G   4% /windows/C
/dev/sda2      4.6G  2.6G  2.1G  57% /windows/D</screen>

   </example>
  </sect2>

  <sect2 xml:id="sec-update-preparation-disk-btrfs-on-root">
   <title>Checking Disk Space on Btrfs Root File Systems</title>
   
   <para>
     On a Btrfs file system, the output of <command>df</command> can
     be misleading, because in addition to the space the raw data allocates, a
     Btrfs file system also allocates and uses space for metadata.
    </para>
    <para>
     Consequently a Btrfs file system may report being out of space even though
     it seems that plenty of space is still available. In that case, all space
     allocated for the metadata is used up.  For more information
     refer to <command>man 8 btrfs-filesystem</command>
     and <link xlink:href="https://btrfs.wiki.kernel.org/index.php/FAQ"/>.
   </para>
   <para>
    If you use Btrfs as root file systems on your machine, make sure there is
    enough free space. Check the available space on all mounted partitions. In
    the worst case, an upgrade needs as much disk space as the current root
    file system (without <filename>/.snapshot</filename>) for a new snapshot.
   </para>
   <para>
    The
    following recommendations have been proven:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      For all file systems including Btrfs you need enough free disk space to
      download and install big RPMs. The space of old RPMs are only freed after
      new RPMs are installed.
     </para>
    </listitem>
    <listitem>
     <para>
      For Btrfs with snapshots, you need at minimum as much free space as your
      current installation takes. We recommend to have twice as much free
      space as the current installation.
     </para>
     <para>
      If you do not have enough free space, you can try to delete old snapshots
      with <command>snapper</command>:
     </para>
<screen><prompt role="root">root # </prompt><command>snapper</command> list
<prompt role="root">root # </prompt><command>snapper</command> delete NUMBER</screen>
     <para>
      However, this may not help in all cases. Before migration, most snapshots
      occupy only little space.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>

 

 
 <sect1 xml:id="sec-update-preparation-multiversion">
  <title>Temporarily Disabling Kernel Multiversion Support</title>
  <para>
   <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> allows installing multiple kernel versions by enabling the
   respective settings in <filename>/etc/zypp/zypp.conf</filename>. Support
   for this feature needs to be temporarily disabled to upgrade to a service
   pack. When the update has successfully finished, multiversion support can be
   re-enabled. To disable multiversion support, comment the respective
   lines in <filename>/etc/zypp/zypp.conf</filename>. The result should look
   similar to:
  </para>
<screen>#multiversion = provides:multiversion(kernel)
#multiversion.kernels = latest,running</screen>
  <para>
   To re-activate this feature after a successful update, remove the comment
   signs. For more information about multiversion support, refer to
   <xref linkend="sec-tuning-multikernel-enable"/>.
  </para>
 </sect1>
 
 
</chapter>
